<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2642px" preserveAspectRatio="none" style="width:1719px;height:2642px;" version="1.1" viewBox="0 0 1719 2642" width="1719px" zoomAndPan="magnify"><defs><filter height="300%" id="f16up5leyiju1s" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="234" x="743.75" y="23.5352">1.1.2. Position Handler Consume</text><rect fill="#FFFFE0" height="2596.8809" style="stroke: #A80036; stroke-width: 1.0;" width="1643.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="800.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="113" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="113" y="1371.5273"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="2429.5938" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="497" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1114" y="1297.2617"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1114" y="2496.8809"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235" y="429.082"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235" y="631.6348"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235" y="1628.7012"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235" y="1831.2539"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1332" y="279.8398"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1332" y="1455.1484"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1430.5" y="780.877"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1430.5" y="1980.4961"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="309.1504"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="458.3926"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="660.9453"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="810.1875"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="1484.459"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="1658.0117"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="1860.5645"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="2009.8066"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="2415.5938" style="stroke: #000000; stroke-width: 2.0;" width="1695.5" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="2384.2832" style="stroke: #000000; stroke-width: 2.0;" width="1675.5" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="135.2422" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="337.7949" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="390.4609"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="135.2422" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="742.2559"/><rect fill="#FFFFFF" height="1206.6191" style="stroke: none; stroke-width: 1.0;" width="1675.5" x="23" y="1335.2617"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="135.2422" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="1416.5273"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="969.1113" style="stroke: #000000; stroke-width: 2.0;" width="1286.5" x="402" y="1565.7695"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="337.7949" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="1590.0801"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="135.2422" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="1941.875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="118" x2="118" y1="116.2871" y2="2565.8809"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="502" x2="502" y1="116.2871" y2="2565.8809"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1119" x2="1119" y1="116.2871" y2="2565.8809"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1240" x2="1240" y1="116.2871" y2="2565.8809"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1337" x2="1337" y1="116.2871" y2="2565.8809"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1435" x2="1435" y1="116.2871" y2="2565.8809"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1620.5" x2="1620.5" y1="116.2871" y2="2565.8809"/><rect fill="#FEFECE" filter="url(#f16up5leyiju1s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#f16up5leyiju1s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="40" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f16up5leyiju1s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="37" y="2564.8809"/><rect fill="#FEFECE" filter="url(#f16up5leyiju1s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="33" y="2568.8809"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="40" y="2589.416">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="422" y="113.334">Position Event Handler</text><ellipse cx="502" cy="83.7988" fill="#FEFECE" filter="url(#f16up5leyiju1s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="498,71.7988,504,66.7988,502,71.7988,504,76.7988,498,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="422" y="2578.416">Position Event Handler</text><ellipse cx="502" cy="2597.3691" fill="#FEFECE" filter="url(#f16up5leyiju1s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="498,2585.3691,504,2580.3691,502,2585.3691,504,2590.3691,498,2585.3691" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f16up5leyiju1s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1060" y="76.7988"/><rect fill="#FEFECE" filter="url(#f16up5leyiju1s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1056" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1063" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f16up5leyiju1s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1060" y="2564.8809"/><rect fill="#FEFECE" filter="url(#f16up5leyiju1s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1056" y="2568.8809"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1063" y="2589.416">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1192" y="113.334">Position DAO</text><ellipse cx="1240" cy="83.7988" fill="#FEFECE" filter="url(#f16up5leyiju1s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1228" x2="1252" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1192" y="2578.416">Position DAO</text><ellipse cx="1240" cy="2597.3691" fill="#FEFECE" filter="url(#f16up5leyiju1s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1228" x2="1252" y1="2611.3691" y2="2611.3691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="1298" y="113.334">Event DAO</text><ellipse cx="1337" cy="83.7988" fill="#FEFECE" filter="url(#f16up5leyiju1s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1325" x2="1349" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="1298" y="2578.416">Event DAO</text><ellipse cx="1337" cy="2597.3691" fill="#FEFECE" filter="url(#f16up5leyiju1s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1325" x2="1349" y1="2611.3691" y2="2611.3691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1386" y="113.334">Transfer DAO</text><ellipse cx="1435.5" cy="83.7988" fill="#FEFECE" filter="url(#f16up5leyiju1s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1423.5" x2="1447.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1386" y="2578.416">Transfer DAO</text><ellipse cx="1435.5" cy="2597.3691" fill="#FEFECE" filter="url(#f16up5leyiju1s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1423.5" x2="1447.5" y1="2611.3691" y2="2611.3691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1572.5" y="113.334">Central Store</text><path d="M1602.5,63.7988 C1602.5,53.7988 1620.5,53.7988 1620.5,53.7988 C1620.5,53.7988 1638.5,53.7988 1638.5,63.7988 L1638.5,89.7988 C1638.5,99.7988 1620.5,99.7988 1620.5,99.7988 C1620.5,99.7988 1602.5,99.7988 1602.5,89.7988 L1602.5,63.7988 " fill="#FEFECE" filter="url(#f16up5leyiju1s)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1602.5,63.7988 C1602.5,73.7988 1620.5,73.7988 1620.5,73.7988 C1620.5,73.7988 1638.5,73.7988 1638.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1572.5" y="2578.416">Central Store</text><path d="M1602.5,2591.3691 C1602.5,2581.3691 1620.5,2581.3691 1620.5,2581.3691 C1620.5,2581.3691 1638.5,2581.3691 1638.5,2591.3691 L1638.5,2617.3691 C1638.5,2627.3691 1620.5,2627.3691 1620.5,2627.3691 C1620.5,2627.3691 1602.5,2627.3691 1602.5,2617.3691 L1602.5,2591.3691 " fill="#FEFECE" filter="url(#f16up5leyiju1s)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1602.5,2591.3691 C1602.5,2601.3691 1620.5,2601.3691 1620.5,2601.3691 C1620.5,2601.3691 1638.5,2601.3691 1638.5,2591.3691 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="113" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="113" y="1371.5273"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="2429.5938" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="497" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1114" y="1297.2617"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1114" y="2496.8809"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235" y="429.082"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235" y="631.6348"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235" y="1628.7012"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235" y="1831.2539"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1332" y="279.8398"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1332" y="1455.1484"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1430.5" y="780.877"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="88.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1430.5" y="1980.4961"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="309.1504"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="458.3926"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="660.9453"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="810.1875"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="1484.459"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="1658.0117"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="1860.5645"/><rect fill="#FFFFFF" filter="url(#f16up5leyiju1s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1615.5" y="2009.8066"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2415.5938" style="stroke: #000000; stroke-width: 2.0;" width="1695.5" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Position Handler Consume</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2384.2832" style="stroke: #000000; stroke-width: 2.0;" width="1675.5" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="134,192.2188,124,196.2188,134,200.2188,130,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="128" x2="496" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="140" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="153" y="191.4766">Consume Position event message for Payer</text><path d="M412,241.2188 L627,241.2188 L627,248.2188 L617,258.2188 L412,258.2188 L412,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="135.2422" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="427" y="254.7871">Persist Event Information</text><polygon fill="#A80036" points="1320,275.8398,1330,279.8398,1320,283.8398,1324,279.8398" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="1326" y1="279.8398" y2="279.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="514" y="275.0977">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="527" y="275.0977">Request to persist event information</text><polygon fill="#A80036" points="1603.5,305.1504,1613.5,309.1504,1603.5,313.1504,1607.5,309.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1342" x2="1609.5" y1="309.1504" y2="309.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1349" y="304.4082">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="1362" y="304.4082">Persist event information</text><polygon fill="#A80036" points="518,364.4609,508,368.4609,518,372.4609,514,368.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="512" x2="1336" y1="368.4609" y2="368.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="524" y="363.7188">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="537" y="363.7188">Return success</text><path d="M412,390.4609 L711,390.4609 L711,397.4609 L701,407.4609 L412,407.4609 L412,390.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="337.7949" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="390.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="427" y="404.0293">Calculate position and persist change</text><polygon fill="#A80036" points="1223,425.082,1233,429.082,1223,433.082,1227,429.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="1229" y1="429.082" y2="429.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="514" y="424.3398">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="527" y="424.3398">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1603.5,454.3926,1613.5,458.3926,1603.5,462.3926,1607.5,458.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1245" x2="1609.5" y1="458.3926" y2="458.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1252" y="453.6504">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1265" y="453.6504">Retrieve latest position from DB for Payer</text><polygon fill="#A80036" points="518,513.7031,508,517.7031,518,521.7031,514,517.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="512" x2="1239" y1="517.7031" y2="517.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="524" y="512.9609">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="537" y="512.9609">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="549" y1="547.0137" y2="547.0137"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="549" x2="549" y1="547.0137" y2="560.0137"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="508" x2="549" y1="560.0137" y2="560.0137"/><polygon fill="#A80036" points="518,556.0137,508,560.0137,518,564.0137,514,560.0137" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="514" y="542.2715">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="527" y="542.2715">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="549" y1="589.3242" y2="589.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="549" x2="549" y1="589.3242" y2="602.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="508" x2="549" y1="602.3242" y2="602.3242"/><polygon fill="#A80036" points="518,598.3242,508,602.3242,518,606.3242,514,602.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="514" y="584.582">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="527" y="584.582">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1223,627.6348,1233,631.6348,1223,635.6348,1227,631.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="1229" y1="631.6348" y2="631.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="514" y="626.8926">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="536" y="626.8926">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1603.5,656.9453,1613.5,660.9453,1603.5,664.9453,1607.5,660.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1245" x2="1609.5" y1="660.9453" y2="660.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1252" y="656.2031">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1274" y="656.2031">Persist latest position to DB for Payer</text><polygon fill="#A80036" points="518,716.2559,508,720.2559,518,724.2559,514,720.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="512" x2="1239" y1="720.2559" y2="720.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="524" y="715.5137">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="546" y="715.5137">Return success</text><path d="M412,742.2559 L976,742.2559 L976,749.2559 L966,759.2559 L412,759.2559 L412,742.2559 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="135.2422" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="742.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="427" y="755.8242">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1418.5,776.877,1428.5,780.877,1418.5,784.877,1422.5,780.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="1424.5" y1="780.877" y2="780.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="514" y="776.1348">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="536" y="776.1348">Request to persist transfer</text><polygon fill="#A80036" points="1603.5,806.1875,1613.5,810.1875,1603.5,814.1875,1607.5,810.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1440.5" x2="1609.5" y1="810.1875" y2="810.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1447.5" y="805.4453">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1469.5" y="805.4453">Persist transfer</text><polygon fill="#A80036" points="518,865.498,508,869.498,518,873.498,514,869.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="512" x2="1434.5" y1="869.498" y2="869.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="524" y="864.7559">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="546" y="864.7559">Return success</text><path d="M512,889.498 L512,1266.498 L774,1266.498 L774,899.498 L764,889.498 L512,889.498 " fill="#FFFF00" filter="url(#f16up5leyiju1s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M764,889.498 L764,899.498 L774,899.498 L764,889.498 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="518" y="907.0664">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="518" y="922.377">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="534" y="937.6875">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="534" y="952.998">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="534" y="968.3086">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="534" y="983.6191">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="534" y="998.9297">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="550" y="1014.2402">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="550" y="1029.5508">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="534" y="1044.8613">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="534" y="1060.1719">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="550" y="1075.4824">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="566" y="1090.793">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="566" y="1106.1035">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="566" y="1121.4141">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="566" y="1136.7246">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="566" y="1152.0352">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="566" y="1167.3457">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="582" y="1182.6563">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="582" y="1197.9668">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="566" y="1213.2773">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="550" y="1228.5879">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="534" y="1243.8984">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="518" y="1259.209">}</text><polygon fill="#A80036" points="1102,1293.2617,1112,1297.2617,1102,1301.2617,1106,1297.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="1108" y1="1297.2617" y2="1297.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="514" y="1292.5195">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="536" y="1292.5195">Publish Transfer event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1698.5" y1="1336.2617" y2="1336.2617"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="1346.8965">[Consume Batch Messages]</text><polygon fill="#A80036" points="134,1367.5273,124,1371.5273,134,1375.5273,130,1371.5273" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="128" x2="496" y1="1371.5273" y2="1371.5273"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="140" y="1366.7852">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="162" y="1366.7852">Consume Position event batch of messages for Payer</text><path d="M412,1416.5273 L669,1416.5273 L669,1423.5273 L659,1433.5273 L412,1433.5273 L412,1416.5273 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="135.2422" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="1416.5273"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="212" x="427" y="1430.0957">Persist batch Event Information</text><polygon fill="#A80036" points="1320,1451.1484,1330,1455.1484,1320,1459.1484,1324,1455.1484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="1326" y1="1455.1484" y2="1455.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="514" y="1450.4063">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="374" x="536" y="1450.4063">Request to persist event information for batch of messages</text><polygon fill="#A80036" points="1603.5,1480.459,1613.5,1484.459,1603.5,1488.459,1607.5,1484.459" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1342" x2="1609.5" y1="1484.459" y2="1484.459"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1349" y="1479.7168">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="1371" y="1479.7168">Persist event batch information</text><polygon fill="#A80036" points="518,1539.7695,508,1543.7695,518,1547.7695,514,1543.7695" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="512" x2="1336" y1="1543.7695" y2="1543.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="524" y="1539.0273">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="546" y="1539.0273">Return success</text><path d="M402,1565.7695 L476,1565.7695 L476,1572.7695 L466,1582.7695 L402,1582.7695 L402,1565.7695 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="969.1113" style="stroke: #000000; stroke-width: 2.0;" width="1286.5" x="402" y="1565.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="417" y="1579.3379">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="155" x="491" y="1578.4043">[for each message in batch]</text><path d="M412,1590.0801 L711,1590.0801 L711,1597.0801 L701,1607.0801 L412,1607.0801 L412,1590.0801 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="337.7949" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="1590.0801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="427" y="1603.6484">Calculate position and persist change</text><polygon fill="#A80036" points="1223,1624.7012,1233,1628.7012,1223,1632.7012,1227,1628.7012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="1229" y1="1628.7012" y2="1628.7012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="514" y="1623.959">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="536" y="1623.959">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1603.5,1654.0117,1613.5,1658.0117,1603.5,1662.0117,1607.5,1658.0117" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1245" x2="1609.5" y1="1658.0117" y2="1658.0117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1252" y="1653.2695">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1274" y="1653.2695">Retrieve latest position from DB for Payer</text><polygon fill="#A80036" points="518,1713.3223,508,1717.3223,518,1721.3223,514,1717.3223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="512" x2="1239" y1="1717.3223" y2="1717.3223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="524" y="1712.5801">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="546" y="1712.5801">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="549" y1="1746.6328" y2="1746.6328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="549" x2="549" y1="1746.6328" y2="1759.6328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="508" x2="549" y1="1759.6328" y2="1759.6328"/><polygon fill="#A80036" points="518,1755.6328,508,1759.6328,518,1763.6328,514,1759.6328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="514" y="1741.8906">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="424" x="536" y="1741.8906">Calculate latest position (lpos) by incrementing transfer for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="549" y1="1788.9434" y2="1788.9434"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="549" x2="549" y1="1788.9434" y2="1801.9434"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="508" x2="549" y1="1801.9434" y2="1801.9434"/><polygon fill="#A80036" points="518,1797.9434,508,1801.9434,518,1805.9434,514,1801.9434" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="514" y="1784.2012">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="536" y="1784.2012">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1223,1827.2539,1233,1831.2539,1223,1835.2539,1227,1831.2539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="1229" y1="1831.2539" y2="1831.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="514" y="1826.5117">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="536" y="1826.5117">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1603.5,1856.5645,1613.5,1860.5645,1603.5,1864.5645,1607.5,1860.5645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1245" x2="1609.5" y1="1860.5645" y2="1860.5645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1252" y="1855.8223">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1274" y="1855.8223">Persist latest position to DB for Payer</text><polygon fill="#A80036" points="518,1915.875,508,1919.875,518,1923.875,514,1919.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="512" x2="1239" y1="1919.875" y2="1919.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="524" y="1915.1328">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="546" y="1915.1328">Return success</text><path d="M412,1941.875 L976,1941.875 L976,1948.875 L966,1958.875 L412,1958.875 L412,1941.875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="135.2422" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="412" y="1941.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="427" y="1955.4434">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1418.5,1976.4961,1428.5,1980.4961,1418.5,1984.4961,1422.5,1980.4961" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="1424.5" y1="1980.4961" y2="1980.4961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="514" y="1975.7539">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="536" y="1975.7539">Request to persist batch transfer</text><polygon fill="#A80036" points="1603.5,2005.8066,1613.5,2009.8066,1603.5,2013.8066,1607.5,2009.8066" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1440.5" x2="1609.5" y1="2009.8066" y2="2009.8066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1447.5" y="2005.0645">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1469.5" y="2005.0645">Persist batch transfer</text><polygon fill="#A80036" points="518,2065.1172,508,2069.1172,518,2073.1172,514,2069.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="512" x2="1434.5" y1="2069.1172" y2="2069.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="524" y="2064.375">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="546" y="2064.375">Return success</text><path d="M512,2089.1172 L512,2466.1172 L774,2466.1172 L774,2099.1172 L764,2089.1172 L512,2089.1172 " fill="#FFFF00" filter="url(#f16up5leyiju1s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M764,2089.1172 L764,2099.1172 L774,2099.1172 L764,2089.1172 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="518" y="2106.6855">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="518" y="2121.9961">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="534" y="2137.3066">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="534" y="2152.6172">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="534" y="2167.9277">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="534" y="2183.2383">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="534" y="2198.5488">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="550" y="2213.8594">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="550" y="2229.1699">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="534" y="2244.4805">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="534" y="2259.791">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="550" y="2275.1016">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="566" y="2290.4121">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="566" y="2305.7227">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="566" y="2321.0332">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="566" y="2336.3438">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="566" y="2351.6543">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="566" y="2366.9648">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="582" y="2382.2754">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="582" y="2397.5859">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="566" y="2412.8965">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="550" y="2428.207">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="534" y="2443.5176">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="518" y="2458.8281">}</text><polygon fill="#A80036" points="1102,2492.8809,1112,2496.8809,1102,2500.8809,1106,2496.8809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="507" x2="1108" y1="2496.8809" y2="2496.8809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="514" y="2492.1387">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="536" y="2492.1387">Publish Transfer event</text><!--
@startuml
title 1.1.2. Position Handler Consume

autonumber


collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
entity "Event DAO" as EVENT_DAO
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant POS_DAO
    participant EVENT_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume
    alt Consume Single Message
        TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event message for Payer
        activate TOPIC_POSITION_DFSP1
        deactivate TOPIC_POSITION_DFSP1
        group Persist Event Information
            POS_HANDLER -> EVENT_DAO: Request to persist event information
            activate EVENT_DAO
            EVENT_DAO -> DB: Persist event information
            activate DB
            deactivate DB
            EVENT_DAO -> POS_HANDLER: Return success
            deactivate EVENT_DAO
        end

        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS

    else Consume Batch Messages
        TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event batch of messages for Payer
        activate TOPIC_POSITION_DFSP1
        deactivate TOPIC_POSITION_DFSP1

        group Persist batch Event Information
            POS_HANDLER -> EVENT_DAO: Request to persist event information for batch of messages
            activate EVENT_DAO
            EVENT_DAO -> DB: Persist event batch information
            activate DB
            deactivate DB
            EVENT_DAO - -> POS_HANDLER: Return success
            deactivate EVENT_DAO
        end

        loop for each message in batch
            group Calculate position and persist change
                POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
                activate POS_DAO
                POS_DAO -> DB: Retrieve latest position from DB for Payer
                activate DB
                deactivate DB
                POS_DAO - -> POS_HANDLER: Return latest position
                deactivate POS_DAO

                POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) by incrementing transfer for prepare
                POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
                
                POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
                activate POS_DAO
                POS_DAO -> DB: Persist latest position to DB for Payer
                activate DB
                deactivate DB
                POS_DAO - -> POS_HANDLER: Return success
                deactivate POS_DAO
            end
            group Persist Transfer State (with transferState='RESERVED' on position check pass)
                POS_HANDLER -> TRANS_DAO: Request to persist batch transfer
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist batch transfer
                activate DB
                deactivate DB
                TRANS_DAO - -> POS_HANDLER: Return success
                deactivate TRANS_DAO
            end
            note right of POS_HANDLER #yellow
                Message:
                {
                    id: <transferMessage.transferId>
                    from: <transferMessage.payerFsp>,
                    to: <transferMessage.payeeFsp>,
                    type: application/json
                    content: {
                        headers: <transferHeaders>,
                        payload: <transferMessage>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: transfer,
                            action: prepare,
                            createdAt: <timestamp>,
                            state: {
                                status: "success",
                                code: 0
                            }
                        }
                    }
                }
            end note
            POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
            activate TOPIC_TRANSFERS
            deactivate TOPIC_TRANSFERS
        end
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>