<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1447px" preserveAspectRatio="none" style="width:1885px;height:1447px;" version="1.1" viewBox="0 0 1885 1447" width="1885px" zoomAndPan="magnify"><defs><filter height="300%" id="f1tqdx2zes8xpe" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="364" x="761.5" y="23.5352">1.1.2. Position Handler Consume (batch messages)</text><rect fill="#FFFFE0" height="1401.5723" style="stroke: #A80036; stroke-width: 1.0;" width="1802" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="869.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.5977"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="1234.2852" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="478" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1086" y="1308.2617"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1463" y="340.1504"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1463" y="576.0137"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570.5" y="758.5664"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1764" y="369.4609"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1764" y="605.3242"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1764" y="787.877"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="1220.2852" style="stroke: #000000; stroke-width: 2.0;" width="1861" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="46.6211" style="stroke: #000000; stroke-width: 2.0;" width="870" x="393" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="1069.043" style="stroke: #000000; stroke-width: 2.0;" width="1481" x="383" y="277.5293"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="404.416" style="stroke: #000000; stroke-width: 2.0;" width="1448" x="393" y="301.8398"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1461" x="393" y="720.2559"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="108" x2="108" y1="116.2871" y2="1370.5723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="483" x2="483" y1="116.2871" y2="1370.5723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1091" x2="1091" y1="116.2871" y2="1370.5723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1208" x2="1208" y1="116.2871" y2="1370.5723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1336" x2="1336" y1="116.2871" y2="1370.5723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1468" x2="1468" y1="116.2871" y2="1370.5723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1575" x2="1575" y1="116.2871" y2="1370.5723"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1769" x2="1769" y1="116.2871" y2="1370.5723"/><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="1369.5723"/><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="1373.5723"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="1394.1074">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="403" y="113.334">Position Event Handler</text><ellipse cx="483" cy="83.7988" fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="479,71.7988,485,66.7988,483,71.7988,485,76.7988,479,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="403" y="1383.1074">Position Event Handler</text><ellipse cx="483" cy="1402.0605" fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="479,1390.0605,485,1385.0605,483,1390.0605,485,1395.0605,479,1390.0605" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1032" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1028" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1035" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1032" y="1369.5723"/><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1028" y="1373.5723"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1035" y="1394.1074">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1164" y="113.334">Event-Topic</text><ellipse cx="1208.5" cy="83.7988" fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1196.5" x2="1220.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1164" y="1383.1074">Event-Topic</text><ellipse cx="1208.5" cy="1402.0605" fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1196.5" x2="1220.5" y1="1416.0605" y2="1416.0605"/><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1267" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1263" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1270" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1267" y="1369.5723"/><rect fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1263" y="1373.5723"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1270" y="1394.1074">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1420" y="113.334">Position DAO</text><ellipse cx="1468" cy="83.7988" fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1456" x2="1480" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1420" y="1383.1074">Position DAO</text><ellipse cx="1468" cy="1402.0605" fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1456" x2="1480" y1="1416.0605" y2="1416.0605"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1526" y="113.334">Transfer DAO</text><ellipse cx="1575.5" cy="83.7988" fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1563.5" x2="1587.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1526" y="1383.1074">Transfer DAO</text><ellipse cx="1575.5" cy="1402.0605" fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1563.5" x2="1587.5" y1="1416.0605" y2="1416.0605"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1721" y="113.334">Central Store</text><path d="M1751,63.7988 C1751,53.7988 1769,53.7988 1769,53.7988 C1769,53.7988 1787,53.7988 1787,63.7988 L1787,89.7988 C1787,99.7988 1769,99.7988 1769,99.7988 C1769,99.7988 1751,99.7988 1751,89.7988 L1751,63.7988 " fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1751,63.7988 C1751,73.7988 1769,73.7988 1769,73.7988 C1769,73.7988 1787,73.7988 1787,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1721" y="1383.1074">Central Store</text><path d="M1751,1396.0605 C1751,1386.0605 1769,1386.0605 1769,1386.0605 C1769,1386.0605 1787,1386.0605 1787,1396.0605 L1787,1422.0605 C1787,1432.0605 1769,1432.0605 1769,1432.0605 C1769,1432.0605 1751,1432.0605 1751,1422.0605 L1751,1396.0605 " fill="#FEFECE" filter="url(#f1tqdx2zes8xpe)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1751,1396.0605 C1751,1406.0605 1769,1406.0605 1769,1406.0605 C1769,1406.0605 1787,1406.0605 1787,1396.0605 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.5977"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="1234.2852" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="478" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1086" y="1308.2617"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1463" y="340.1504"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1463" y="576.0137"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570.5" y="758.5664"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1764" y="369.4609"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1764" y="605.3242"/><rect fill="#FFFFFF" filter="url(#f1tqdx2zes8xpe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1764" y="787.877"/><rect fill="none" height="1220.2852" style="stroke: #000000; stroke-width: 2.0;" width="1861" x="13" y="133.2871"/><polygon fill="#EEEEEE" points="13,133.2871,236,133.2871,236,140.2871,226,150.2871,13,150.2871,13,133.2871" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Position Handler Consume</text><polygon fill="#A80036" points="124,167.5977,114,171.5977,124,175.5977,120,171.5977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="118" x2="477" y1="171.5977" y2="171.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="130" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="143" y="167.166">Consume Position event batch of messages for Payer</text><rect fill="none" height="46.6211" style="stroke: #000000; stroke-width: 2.0;" width="870" x="393" y="216.9082"/><polygon fill="#EEEEEE" points="393,216.9082,608,216.9082,608,223.9082,598,233.9082,393,233.9082,393,216.9082" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="408" y="230.4766">Persist Event Information</text><polygon fill="#A80036" points="1196.5,251.2188,1206.5,255.2188,1196.5,259.2188,1200.5,255.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="1202.5" y1="255.2188" y2="255.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="250.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="508" y="250.7871">Request to persist event information</text><rect fill="none" height="1069.043" style="stroke: #000000; stroke-width: 2.0;" width="1481" x="383" y="277.5293"/><polygon fill="#EEEEEE" points="383,277.5293,457,277.5293,457,284.5293,447,294.5293,383,294.5293,383,277.5293" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="398" y="291.0977">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="155" x="472" y="290.1641">[for each message in batch]</text><rect fill="none" height="404.416" style="stroke: #000000; stroke-width: 2.0;" width="1448" x="393" y="301.8398"/><polygon fill="#EEEEEE" points="393,301.8398,692,301.8398,692,308.8398,682,318.8398,393,318.8398,393,301.8398" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="408" y="315.4082">Calculate position and persist change</text><polygon fill="#A80036" points="1451,336.1504,1461,340.1504,1451,344.1504,1455,340.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="1457" y1="340.1504" y2="340.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="335.7188">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="508" y="335.7188">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1752,365.4609,1762,369.4609,1752,373.4609,1756,369.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1473" x2="1758" y1="369.4609" y2="369.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1480" y="365.0293">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1493" y="365.0293">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1tqdx2zes8xpe)" points="1717,412.7715,1821,412.7715,1831,423.7715,1821,435.7715,1717,435.7715,1707,423.7715,1717,412.7715" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1719" y="429.3398">transferPosition</text><polygon fill="#A80036" points="499,458.082,489,462.082,499,466.082,495,462.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="493" x2="1467" y1="462.082" y2="462.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="505" y="457.6504">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="518" y="457.6504">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="530" y1="491.7031" y2="491.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="530" x2="530" y1="491.7031" y2="504.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="489" x2="530" y1="504.7031" y2="504.7031"/><polygon fill="#A80036" points="499,500.7031,489,504.7031,499,508.7031,495,504.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="486.9609">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="424" x="508" y="486.9609">Calculate latest position (lpos) by incrementing transfer for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="530" y1="534.0137" y2="534.0137"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="530" x2="530" y1="534.0137" y2="547.0137"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="489" x2="530" y1="547.0137" y2="547.0137"/><polygon fill="#A80036" points="499,543.0137,489,547.0137,499,551.0137,495,547.0137" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="529.2715">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="508" y="529.2715">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1451,572.0137,1461,576.0137,1451,580.0137,1455,576.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="1457" y1="576.0137" y2="576.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="571.582">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="508" y="571.582">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1752,601.3242,1762,605.3242,1752,609.3242,1756,605.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1473" x2="1758" y1="605.3242" y2="605.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1480" y="600.8926">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1493" y="600.8926">Persist latest position to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1tqdx2zes8xpe)" points="1717,648.6348,1821,648.6348,1831,659.6348,1821,671.6348,1717,671.6348,1707,659.6348,1717,648.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1719" y="665.2031">transferPosition</text><polygon fill="#A80036" points="499,693.9453,489,697.9453,499,701.9453,495,697.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="493" x2="1467" y1="697.9453" y2="697.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="505" y="693.5137">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="527" y="693.5137">Return success</text><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1461" x="393" y="720.2559"/><polygon fill="#EEEEEE" points="393,720.2559,957,720.2559,957,727.2559,947,737.2559,393,737.2559,393,720.2559" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="408" y="733.8242">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1558.5,754.5664,1568.5,758.5664,1558.5,762.5664,1562.5,758.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="1564.5" y1="758.5664" y2="758.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="495" y="754.1348">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="517" y="754.1348">Request to persist batch transfer</text><polygon fill="#A80036" points="1752,783.877,1762,787.877,1752,791.877,1756,787.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1580.5" x2="1758" y1="787.877" y2="787.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1587.5" y="783.4453">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1609.5" y="783.4453">Persist batch transfer</text><polygon fill="#FFFFE0" filter="url(#f1tqdx2zes8xpe)" points="1703,831.1875,1834,831.1875,1844,842.1875,1834,854.1875,1703,854.1875,1693,842.1875,1703,831.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1705" y="847.7559">transferStateChange</text><polygon fill="#A80036" points="499,876.498,489,880.498,499,884.498,495,880.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="493" x2="1574.5" y1="880.498" y2="880.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="505" y="876.0664">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="527" y="876.0664">Return success</text><polygon fill="#FFFF00" filter="url(#f1tqdx2zes8xpe)" points="493,900.8086,493,1277.8086,755,1277.8086,755,910.8086,745,900.8086,493,900.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="745" x2="745" y1="900.8086" y2="910.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="755" x2="745" y1="910.8086" y2="910.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="499" y="918.377">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="499" y="933.6875">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="515" y="948.998">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="515" y="964.3086">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="515" y="979.6191">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="515" y="994.9297">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="515" y="1010.2402">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="531" y="1025.5508">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="531" y="1040.8613">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="515" y="1056.1719">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="515" y="1071.4824">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="531" y="1086.793">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="547" y="1102.1035">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="547" y="1117.4141">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="547" y="1132.7246">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="547" y="1148.0352">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="547" y="1163.3457">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="547" y="1178.6563">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="563" y="1193.9668">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="563" y="1209.2773">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="547" y="1224.5879">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="531" y="1239.8984">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="515" y="1255.209">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="499" y="1270.5195">}</text><polygon fill="#A80036" points="1074,1304.2617,1084,1308.2617,1074,1312.2617,1078,1308.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="1080" y1="1308.2617" y2="1308.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="495" y="1303.8301">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="517" y="1303.8301">Publish Transfer event</text><!--
@startuml
' declate title
title 1.1.2. Position Handler Consume (batch messages)

autonumber

' Actor Keys:
'   boundary - APIs/Interfaces, etc
'   collections - Kafka Topics
'   control - Kafka Consumers
'   entity - Database Access Objects
'   database - Database Persistance Store

' declare actors
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
entity "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant TRANS_DAO
    participant DB
end box

' start flow
activate POS_HANDLER
group Position Handler Consume
    TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event batch of messages for Payer
    activate TOPIC_POSITION_DFSP1
    deactivate TOPIC_POSITION_DFSP1

    group Persist Event Information
        POS_HANDLER -> TOPIC_EVENTS: Request to persist event information
    end

    loop for each message in batch
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) by incrementing transfer for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist batch transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist batch transfer
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2017.18(Fri Oct 06 17:56:32 BST 2017)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_152-b16
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>