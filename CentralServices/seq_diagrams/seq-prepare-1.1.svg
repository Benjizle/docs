<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2841px" preserveAspectRatio="none" style="width:3841px;height:2841px;" version="1.1" viewBox="0 0 3841 2841" width="3841px" zoomAndPan="magnify"><defs><filter height="300%" id="f79xwy9ngfnui" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="385" x="1729.25" y="23.5352">1.1 DFSP1 sends a Prepare Transfer request to DFSP2</text><rect fill="#ADD8E6" height="2796.1738" style="stroke: #A80036; stroke-width: 1.0;" width="186" x="4" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="7" y="47.0566">Financial Service Providers</text><rect fill="#90EE90" height="2796.1738" style="stroke: #A80036; stroke-width: 1.0;" width="361" x="286.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="388.5" y="47.0566">ML API Adapter Service</text><rect fill="#FFFFE0" height="2796.1738" style="stroke: #A80036; stroke-width: 1.0;" width="2837.5" x="987" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="2355.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f79xwy9ngfnui)" height="444.5215" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="340.5" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f79xwy9ngfnui)" height="263.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="522" y="2455.0684"/><rect fill="#FFFFFF" filter="url(#f79xwy9ngfnui)" height="469.832" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1598" y="591.8086"/><rect fill="#FFFFFF" filter="url(#f79xwy9ngfnui)" height="649.0059" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2261" y="1061.6406"/><rect fill="#FFFFFF" filter="url(#f79xwy9ngfnui)" height="2572.8867" style="stroke: #000000; stroke-width: 2.0;" width="3797.5" x="33" y="154.2871"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="67" x2="67" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="126" x2="126" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="345.5" x2="345.5" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="526.5" x2="526.5" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1058" x2="1058" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1219" x2="1219" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1603" x2="1603" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1932" x2="1932" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2266" x2="2266" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2707" x2="2707" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2912.5" x2="2912.5" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3207.5" x2="3207.5" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3339.5" x2="3339.5" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3436.5" x2="3436.5" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3534.5" x2="3534.5" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3654.5" x2="3654.5" y1="137.2871" y2="2744.1738"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3772.5" x2="3772.5" y1="137.2871" y2="2744.1738"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="43" y="134.334">DFSP1</text><ellipse cx="67.5" cy="63.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M67.5,71.7988 L67.5,98.7988 M54.5,79.7988 L80.5,79.7988 M67.5,98.7988 L54.5,113.7988 M67.5,98.7988 L80.5,113.7988 " fill="#FEFECE" filter="url(#f79xwy9ngfnui)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="43" y="2756.709">DFSP1</text><ellipse cx="67.5" cy="2769.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M67.5,2777.6621 L67.5,2804.6621 M54.5,2785.6621 L80.5,2785.6621 M67.5,2804.6621 L54.5,2819.6621 M67.5,2804.6621 L80.5,2819.6621 " fill="#FEFECE" filter="url(#f79xwy9ngfnui)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="102" y="134.334">DFSP2</text><ellipse cx="126.5" cy="63.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M126.5,71.7988 L126.5,98.7988 M113.5,79.7988 L139.5,79.7988 M126.5,98.7988 L113.5,113.7988 M126.5,98.7988 L139.5,113.7988 " fill="#FEFECE" filter="url(#f79xwy9ngfnui)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="102" y="2756.709">DFSP2</text><ellipse cx="126.5" cy="2769.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M126.5,2777.6621 L126.5,2804.6621 M113.5,2785.6621 L139.5,2785.6621 M126.5,2804.6621 L113.5,2819.6621 M126.5,2804.6621 L139.5,2819.6621 " fill="#FEFECE" filter="url(#f79xwy9ngfnui)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="290.5" y="134.334">ML API Adapter</text><path d="M325,92.7988 L325,116.7988 M325,104.7988 L342,104.7988 " fill="#FEFECE" filter="url(#f79xwy9ngfnui)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354" cy="104.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="290.5" y="2756.709">ML API Adapter</text><path d="M325,2763.6621 L325,2787.6621 M325,2775.6621 L342,2775.6621 " fill="#FEFECE" filter="url(#f79xwy9ngfnui)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354" cy="2775.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="227" x="410.5" y="134.334">ML API Notification Event Handler</text><ellipse cx="527" cy="104.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="523,92.7988,529,87.7988,527,92.7988,529,97.7988,523,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="227" x="410.5" y="2756.709">ML API Notification Event Handler</text><ellipse cx="527" cy="2775.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="523,2763.6621,529,2758.6621,527,2763.6621,529,2768.6621,523,2763.6621" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128" x="991" y="134.334">Central Service API</text><path d="M1037.5,92.7988 L1037.5,116.7988 M1037.5,104.7988 L1054.5,104.7988 " fill="#FEFECE" filter="url(#f79xwy9ngfnui)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="1066.5" cy="104.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128" x="991" y="2756.709">Central Service API</text><path d="M1037.5,2763.6621 L1037.5,2787.6621 M1037.5,2775.6621 L1054.5,2775.6621 " fill="#FEFECE" filter="url(#f79xwy9ngfnui)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="1066.5" cy="2775.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="1139" y="97.7988"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="1135" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="1142" y="122.334">Prepare-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="1139" y="2743.1738"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="1135" y="2747.1738"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="1142" y="2767.709">Prepare-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="1524" y="134.334">Prepare Event Handler</text><ellipse cx="1603" cy="104.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1599,92.7988,1605,87.7988,1603,92.7988,1605,97.7988,1599,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="1524" y="2756.709">Prepare Event Handler</text><ellipse cx="1603" cy="2775.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1599,2763.6621,1605,2758.6621,1603,2763.6621,1605,2768.6621,1599,2763.6621" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="1851" y="97.7988"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="1847" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="1854" y="122.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="1851" y="2743.1738"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="1847" y="2747.1738"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="1854" y="2767.709">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="2186" y="134.334">Position Event Handler</text><ellipse cx="2266" cy="104.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2262,92.7988,2268,87.7988,2266,92.7988,2268,97.7988,2262,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="2186" y="2756.709">Position Event Handler</text><ellipse cx="2266" cy="2775.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2262,2763.6621,2268,2758.6621,2266,2763.6621,2268,2768.6621,2262,2763.6621" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="2648" y="97.7988"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="2644" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="2651" y="122.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="2648" y="2743.1738"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="2644" y="2747.1738"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="2651" y="2767.709">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="2831.5" y="134.334">Transfer Event Handler</text><ellipse cx="2913" cy="104.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2909,92.7988,2915,87.7988,2913,92.7988,2915,97.7988,2909,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="2831.5" y="2756.709">Transfer Event Handler</text><ellipse cx="2913" cy="2775.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2909,2763.6621,2915,2758.6621,2913,2763.6621,2915,2768.6621,2909,2763.6621" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="3138.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="3134.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="3141.5" y="122.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="3138.5" y="2743.1738"/><rect fill="#FEFECE" filter="url(#f79xwy9ngfnui)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="3134.5" y="2747.1738"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="3141.5" y="2767.709">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="3291.5" y="134.334">Position DAO</text><ellipse cx="3339.5" cy="104.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3327.5" x2="3351.5" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="3291.5" y="2756.709">Position DAO</text><ellipse cx="3339.5" cy="2775.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3327.5" x2="3351.5" y1="2789.6621" y2="2789.6621"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="3397.5" y="134.334">Event DAO</text><ellipse cx="3436.5" cy="104.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3424.5" x2="3448.5" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="3397.5" y="2756.709">Event DAO</text><ellipse cx="3436.5" cy="2775.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3424.5" x2="3448.5" y1="2789.6621" y2="2789.6621"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="3485.5" y="134.334">Transfer DAO</text><ellipse cx="3535" cy="104.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3523" x2="3547" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="3485.5" y="2756.709">Transfer DAO</text><ellipse cx="3535" cy="2775.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3523" x2="3547" y1="2789.6621" y2="2789.6621"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="3594.5" y="134.334">Notification DAO</text><ellipse cx="3654.5" cy="104.7988" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3642.5" x2="3666.5" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="3594.5" y="2756.709">Notification DAO</text><ellipse cx="3654.5" cy="2775.6621" fill="#FEFECE" filter="url(#f79xwy9ngfnui)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3642.5" x2="3666.5" y1="2789.6621" y2="2789.6621"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="3724.5" y="134.334">Central Store</text><path d="M3754.5,84.7988 C3754.5,74.7988 3772.5,74.7988 3772.5,74.7988 C3772.5,74.7988 3790.5,74.7988 3790.5,84.7988 L3790.5,110.7988 C3790.5,120.7988 3772.5,120.7988 3772.5,120.7988 C3772.5,120.7988 3754.5,120.7988 3754.5,110.7988 L3754.5,84.7988 " fill="#FEFECE" filter="url(#f79xwy9ngfnui)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M3754.5,84.7988 C3754.5,94.7988 3772.5,94.7988 3772.5,94.7988 C3772.5,94.7988 3790.5,94.7988 3790.5,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="3724.5" y="2756.709">Central Store</text><path d="M3754.5,2769.6621 C3754.5,2759.6621 3772.5,2759.6621 3772.5,2759.6621 C3772.5,2759.6621 3790.5,2759.6621 3790.5,2769.6621 L3790.5,2795.6621 C3790.5,2805.6621 3772.5,2805.6621 3772.5,2805.6621 C3772.5,2805.6621 3754.5,2805.6621 3754.5,2795.6621 L3754.5,2769.6621 " fill="#FEFECE" filter="url(#f79xwy9ngfnui)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M3754.5,2769.6621 C3754.5,2779.6621 3772.5,2779.6621 3772.5,2779.6621 C3772.5,2779.6621 3790.5,2779.6621 3790.5,2769.6621 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f79xwy9ngfnui)" height="444.5215" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="340.5" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f79xwy9ngfnui)" height="263.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="522" y="2455.0684"/><rect fill="#FFFFFF" filter="url(#f79xwy9ngfnui)" height="469.832" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1598" y="591.8086"/><rect fill="#FFFFFF" filter="url(#f79xwy9ngfnui)" height="649.0059" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2261" y="1061.6406"/><rect fill="none" height="2572.8867" style="stroke: #000000; stroke-width: 2.0;" width="3797.5" x="33" y="154.2871"/><polygon fill="#EEEEEE" points="33,154.2871,95,154.2871,95,161.2871,85,171.2871,33,171.2871,33,154.2871" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="48" y="167.8555">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="286" x="110" y="166.9219">[DFSP1 sends a Prepare Transfer request to DFSP2]</text><polygon fill="#A80036" points="328.5,188.5977,338.5,192.5977,328.5,196.5977,332.5,192.5977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="67.5" x2="334.5" y1="192.5977" y2="192.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="74.5" y="188.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="87.5" y="188.166">POST - http://transfers</text><polygon fill="#FFFF00" filter="url(#f79xwy9ngfnui)" points="355,205.9082,355,459.9082,579,459.9082,579,215.9082,569,205.9082,355,205.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="569" x2="569" y1="205.9082" y2="215.9082"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="569" y1="215.9082" y2="215.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="361" y="223.4766">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="361" y="238.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="377" y="254.0977">id: &lt;transferMessage.id&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="377" y="269.4082">from: http://ledger/dfsp1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="377" y="284.7188">to: http://ledger/dfsp2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="377" y="300.0293">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="377" y="315.3398">content: &lt;transferMessage&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="377" y="330.6504">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="393" y="345.9609">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="409" y="361.2715">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="409" y="376.582">type: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="409" y="391.8926">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="409" y="407.2031">createdAt: &lt;timestamp&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="422.5137">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="437.8242">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="361" y="453.1348">}</text><polygon fill="#A80036" points="1207,486.877,1217,490.877,1207,494.877,1211,490.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="350.5" x2="1213" y1="490.877" y2="490.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="357.5" y="486.4453">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="370.5" y="486.4453">Routes &amp; Publishes Prepare event for DFSP1</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1219" x2="1261" y1="520.498" y2="520.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1261" x2="1261" y1="520.498" y2="533.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1220" x2="1261" y1="533.498" y2="533.498"/><polygon fill="#A80036" points="1230,529.498,1220,533.498,1230,537.498,1226,533.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1226" y="515.7559">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="1239" y="515.7559">Ensures that event is replicated as configured (ACKS=all)</text><polygon fill="#A80036" points="361.5,558.498,351.5,562.498,361.5,566.498,357.5,562.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355.5" x2="1218" y1="562.498" y2="562.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="367.5" y="558.0664">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="380.5" y="558.0664">Responds replication acknoledgements have been received</text><polygon fill="#A80036" points="78.5,587.8086,68.5,591.8086,78.5,595.8086,74.5,591.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="344.5" y1="591.8086" y2="591.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="84.5" y="587.377">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="97.5" y="587.377">Respond HTTP - 202 (Accepted)</text><polygon fill="#A80036" points="1586,617.1191,1596,621.1191,1586,625.1191,1590,621.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1219" x2="1592" y1="621.1191" y2="621.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1226" y="616.6875">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="1239" y="616.6875">Consumes Prepare event message for DFSP1</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1608" x2="1650" y1="650.7402" y2="650.7402"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1650" x2="1650" y1="650.7402" y2="663.7402"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1609" x2="1650" y1="663.7402" y2="663.7402"/><polygon fill="#A80036" points="1619,659.7402,1609,663.7402,1619,667.7402,1615,663.7402" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1615" y="645.998">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1628" y="645.998">Validates from - DFSP1</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1608" x2="1650" y1="693.0508" y2="693.0508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1650" x2="1650" y1="693.0508" y2="706.0508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1609" x2="1650" y1="706.0508" y2="706.0508"/><polygon fill="#A80036" points="1619,702.0508,1609,706.0508,1619,710.0508,1615,706.0508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1615" y="688.3086">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="1628" y="688.3086">Validates to - DFSP2</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1608" x2="1650" y1="735.3613" y2="735.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1650" x2="1650" y1="735.3613" y2="748.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1609" x2="1650" y1="748.3613" y2="748.3613"/><polygon fill="#A80036" points="1619,744.3613,1609,748.3613,1619,752.3613,1615,748.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1615" y="730.6191">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="1628" y="730.6191">Validates message signature</text><polygon fill="#FFFF00" filter="url(#f79xwy9ngfnui)" points="1613,761.3613,1613,1031.3613,1873,1031.3613,1873,771.3613,1863,761.3613,1613,761.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1863" x2="1863" y1="761.3613" y2="771.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1873" x2="1863" y1="771.3613" y2="771.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="1619" y="778.9297">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1619" y="794.2402">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="1635" y="809.5508">id: &lt;transferMessage.id&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="1635" y="824.8613">from: http://ledger/dfsp1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="1635" y="840.1719">to: http://ledger/dfsp2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1635" y="855.4824">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="1635" y="870.793">content: &lt;transferMessage&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="1635" y="886.1035">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1651" y="901.4141">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="1667" y="916.7246">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="1667" y="932.0352">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="1667" y="947.3457">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="1667" y="962.6563">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="1667" y="977.9668">createdAt: &lt;timestamp&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1651" y="993.2773">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1635" y="1008.5879">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1619" y="1023.8984">}</text><polygon fill="#A80036" points="1920,1057.6406,1930,1061.6406,1920,1065.6406,1924,1061.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1603" x2="1926" y1="1061.6406" y2="1061.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1610" y="1057.209">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="1632" y="1057.209">Routes &amp; Publishes Position event for DFSP1</text><polygon fill="#A80036" points="2249,1086.9512,2259,1090.9512,2249,1094.9512,2253,1090.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1932" x2="2255" y1="1090.9512" y2="1090.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1939" y="1086.5195">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="1961" y="1086.5195">Consumes Position event message for DFSP1</text><polygon fill="#A80036" points="3327.5,1116.2617,3337.5,1120.2617,3327.5,1124.2617,3331.5,1120.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2271" x2="3333.5" y1="1120.2617" y2="1120.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2278" y="1115.8301">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="2300" y="1115.8301">Request latest position from DB for DFSP1</text><polygon fill="#A80036" points="3350.5,1145.5723,3340.5,1149.5723,3350.5,1153.5723,3346.5,1149.5723" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="3760.5,1145.5723,3770.5,1149.5723,3760.5,1153.5723,3764.5,1149.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3344.5" x2="3766.5" y1="1149.5723" y2="1149.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3356.5" y="1145.1406">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="3378.5" y="1145.1406">Retrieves latest position from DB for DFSP1</text><polygon fill="#A80036" points="2282,1174.8828,2272,1178.8828,2282,1182.8828,2278,1178.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2276" x2="3338.5" y1="1178.8828" y2="1178.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2288" y="1174.4512">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="2310" y="1174.4512">Return success</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2271" x2="2313" y1="1208.5039" y2="1208.5039"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2313" x2="2313" y1="1208.5039" y2="1221.5039"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2272" x2="2313" y1="1221.5039" y2="1221.5039"/><polygon fill="#A80036" points="2282,1217.5039,2272,1221.5039,2282,1225.5039,2278,1221.5039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2278" y="1203.7617">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="2300" y="1203.7617">Calculates latest position by decrementing transfer for prepare</text><polygon fill="#A80036" points="3327.5,1246.5039,3337.5,1250.5039,3327.5,1254.5039,3331.5,1250.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2271" x2="3333.5" y1="1250.5039" y2="1250.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2278" y="1246.0723">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="2300" y="1246.0723">Request to persist latest position for DFSP1</text><polygon fill="#A80036" points="3350.5,1275.8145,3340.5,1279.8145,3350.5,1283.8145,3346.5,1279.8145" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="3760.5,1275.8145,3770.5,1279.8145,3760.5,1283.8145,3764.5,1279.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3344.5" x2="3766.5" y1="1279.8145" y2="1279.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3356.5" y="1275.3828">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="3378.5" y="1275.3828">Persists latest position to DB for DFSP1</text><polygon fill="#A80036" points="2282,1305.125,2272,1309.125,2282,1313.125,2278,1309.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2276" x2="3338.5" y1="1309.125" y2="1309.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2288" y="1304.6934">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="2310" y="1304.6934">return success</text><polygon fill="#A80036" points="3424.5,1334.4355,3434.5,1338.4355,3424.5,1342.4355,3428.5,1338.4355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2271" x2="3430.5" y1="1338.4355" y2="1338.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2278" y="1334.0039">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="2300" y="1334.0039">Request to persist event information</text><polygon fill="#A80036" points="3447.5,1363.7461,3437.5,1367.7461,3447.5,1371.7461,3443.5,1367.7461" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="3760.5,1363.7461,3770.5,1367.7461,3760.5,1371.7461,3764.5,1367.7461" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3441.5" x2="3766.5" y1="1367.7461" y2="1367.7461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3453.5" y="1363.3145">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="3475.5" y="1363.3145">Persist event information</text><polygon fill="#A80036" points="2282,1393.0566,2272,1397.0566,2282,1401.0566,2278,1397.0566" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2276" x2="3435.5" y1="1397.0566" y2="1397.0566"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2288" y="1392.625">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="2310" y="1392.625">return success</text><polygon fill="#FFFF00" filter="url(#f79xwy9ngfnui)" points="2276,1410.3672,2276,1680.3672,2536,1680.3672,2536,1420.3672,2526,1410.3672,2276,1410.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2526" x2="2526" y1="1410.3672" y2="1420.3672"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2536" x2="2526" y1="1420.3672" y2="1420.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="2282" y="1427.9355">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2282" y="1443.2461">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="2298" y="1458.5566">id: &lt;transferMessage.id&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="2298" y="1473.8672">from: http://ledger/dfsp1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="2298" y="1489.1777">to: http://ledger/dfsp2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="2298" y="1504.4883">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="2298" y="1519.7988">content: &lt;transferMessage&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="2298" y="1535.1094">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="2314" y="1550.4199">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="2330" y="1565.7305">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="2330" y="1581.041">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="2330" y="1596.3516">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="2330" y="1611.6621">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="2330" y="1626.9727">createdAt: &lt;timestamp&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2314" y="1642.2832">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2298" y="1657.5938">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2282" y="1672.9043">}</text><polygon fill="#A80036" points="2695,1706.6465,2705,1710.6465,2695,1714.6465,2699,1710.6465" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2266" x2="2701" y1="1710.6465" y2="1710.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2273" y="1706.2148">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="2295" y="1706.2148">Publishes Transfer event</text><polygon fill="#A80036" points="2901,1735.957,2911,1739.957,2901,1743.957,2905,1739.957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2707" x2="2907" y1="1739.957" y2="1739.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2714" y="1735.5254">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="2736" y="1735.5254">Consumes Transfer event</text><polygon fill="#A80036" points="3523,1765.2676,3533,1769.2676,3523,1773.2676,3527,1769.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2913" x2="3529" y1="1769.2676" y2="1769.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2920" y="1764.8359">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="2942" y="1764.8359">Request to Transfer status to DB</text><polygon fill="#A80036" points="3546,1794.5781,3536,1798.5781,3546,1802.5781,3542,1798.5781" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="3760.5,1794.5781,3770.5,1798.5781,3760.5,1802.5781,3764.5,1798.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3540" x2="3766.5" y1="1798.5781" y2="1798.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3552" y="1794.1465">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="3574" y="1794.1465">return success</text><polygon fill="#A80036" points="2924,1823.8887,2914,1827.8887,2924,1831.8887,2920,1827.8887" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2918" x2="3534" y1="1827.8887" y2="1827.8887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2930" y="1823.457">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="2952" y="1823.457">Persists Transfer status to DB</text><polygon fill="#FFFF00" filter="url(#f79xwy9ngfnui)" points="2918,1841.1992,2918,2111.1992,3198,2111.1992,3198,1851.1992,3188,1841.1992,2918,1841.1992" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3188" x2="3188" y1="1841.1992" y2="1851.1992"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3198" x2="3188" y1="1851.1992" y2="1851.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="2924" y="1858.7676">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2924" y="1874.0781">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="2940" y="1889.3887">id: &lt;transferMessage.id&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="2940" y="1904.6992">from: http://ledger/dfsp1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="2940" y="1920.0098">to: http://ledger/dfsp1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="2940" y="1935.3203">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="2940" y="1950.6309">content: &lt;transferResponseMessage&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="2940" y="1965.9414">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="2956" y="1981.252">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="2972" y="1996.5625">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="2972" y="2011.873">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="2972" y="2027.1836">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="2972" y="2042.4941">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="2972" y="2057.8047">createdAt: &lt;timestamp&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2956" y="2073.1152">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2940" y="2088.4258">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2924" y="2103.7363">}</text><polygon fill="#A80036" points="3196,2137.4785,3206,2141.4785,3196,2145.4785,3200,2141.4785" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2913" x2="3202" y1="2141.4785" y2="2141.4785"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2920" y="2137.0469">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="2942" y="2137.0469">Publishes Notifications event for DFSP1</text><polygon fill="#FFFF00" filter="url(#f79xwy9ngfnui)" points="2918,2154.7891,2918,2424.7891,3198,2424.7891,3198,2164.7891,3188,2154.7891,2918,2154.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3188" x2="3188" y1="2154.7891" y2="2164.7891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3198" x2="3188" y1="2164.7891" y2="2164.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="2924" y="2172.3574">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2924" y="2187.668">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="2940" y="2202.9785">id: &lt;transferMessage.id&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="2940" y="2218.2891">from: http://ledger/dfsp1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="2940" y="2233.5996">to: http://ledger/dfsp2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="2940" y="2248.9102">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="2940" y="2264.2207">content: &lt;transferResponseMessage&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="2940" y="2279.5313">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="2956" y="2294.8418">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="2972" y="2310.1523">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="2972" y="2325.4629">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="2972" y="2340.7734">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="2972" y="2356.084">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="2972" y="2371.3945">createdAt: &lt;timestamp&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2956" y="2386.7051">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2940" y="2402.0156">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2924" y="2417.3262">}</text><polygon fill="#A80036" points="3196,2451.0684,3206,2455.0684,3196,2459.0684,3200,2455.0684" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2913" x2="3202" y1="2455.0684" y2="2455.0684"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2920" y="2450.6367">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="2942" y="2450.6367">Publishes Notifications event for DFSP2</text><polygon fill="#A80036" points="543,2480.3789,533,2484.3789,543,2488.3789,539,2484.3789" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="537" x2="3207" y1="2484.3789" y2="2484.3789"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="549" y="2479.9473">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="571" y="2479.9473">Consumes Notifications event</text><polygon fill="#A80036" points="1046,2509.6895,1056,2513.6895,1046,2517.6895,1050,2513.6895" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="532" x2="1052" y1="2513.6895" y2="2513.6895"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="539" y="2509.2578">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="480" x="561" y="2509.2578">Requests Notification details for DFSP1 - GET - HTTP://notifications/DFPS1</text><polygon fill="#A80036" points="1069,2539,1059,2543,1069,2547,1065,2543" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="3642.5,2539,3652.5,2543,3642.5,2547,3646.5,2543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1063" x2="3648.5" y1="2543" y2="2543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1075" y="2538.5684">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="1097" y="2538.5684">Fetches Notifications details for DFSP1</text><polygon fill="#A80036" points="543,2568.3105,533,2572.3105,543,2576.3105,539,2572.3105" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="537" x2="1057" y1="2572.3105" y2="2572.3105"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="549" y="2567.8789">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="571" y="2567.8789">Returns Notifications details for DFSP1</text><polygon fill="#A80036" points="78.5,2597.6211,68.5,2601.6211,78.5,2605.6211,74.5,2601.6211" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="521" y1="2601.6211" y2="2601.6211"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="84.5" y="2597.1895">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="106.5" y="2597.1895">HTTP Callback with Prepare result to DFSP1</text><polygon fill="#A80036" points="1046,2626.9316,1056,2630.9316,1046,2634.9316,1050,2630.9316" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="532" x2="1052" y1="2630.9316" y2="2630.9316"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="539" y="2626.5">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="480" x="561" y="2626.5">Requests Notification details for DFSP2 - GET - HTTP://notifications/DFPS2</text><polygon fill="#A80036" points="1069,2656.2422,1059,2660.2422,1069,2664.2422,1065,2660.2422" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="3642.5,2656.2422,3652.5,2660.2422,3642.5,2664.2422,3646.5,2660.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1063" x2="3648.5" y1="2660.2422" y2="2660.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1075" y="2655.8105">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="1097" y="2655.8105">Fetches Notifications details for DFSP2</text><polygon fill="#A80036" points="543,2685.5527,533,2689.5527,543,2693.5527,539,2689.5527" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="537" x2="1057" y1="2689.5527" y2="2689.5527"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="549" y="2685.1211">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="571" y="2685.1211">Returns Notifications details for DFSP2</text><polygon fill="#A80036" points="137.5,2714.8633,127.5,2718.8633,137.5,2722.8633,133.5,2718.8633" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="131.5" x2="526" y1="2718.8633" y2="2718.8633"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="143.5" y="2714.4316">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="165.5" y="2714.4316">HTTP Callback with Prepare result to DFSP2</text><!--
@startuml
' declate title
title 1.1 DFSP1 sends a Prepare Transfer request to DFSP2

autonumber

' Actor Keys:
'   boundary - APIs/Interfaces, etc
'   collections - Kafka Topics
'   control - Kafka Consumers
'   entity - Database Access Objects
'   database - Database Persistance Store

' declare actors
actor DFSP1
actor DFSP2
boundary "ML API Adapter" as MLAPI
control "ML API Notification Event Handler" as NOTIFY_HANDLER
boundary "Central Service API" as CSAPI
collections "Prepare-Topic-dfsp1" as TOPIC_PREPARE_DFSP1
control "Prepare Event Handler" as PREP_HANDLER
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
control "Transfer Event Handler" as TRANS_HANDLER
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
entity "Event DAO" as EVENT_DAO
entity "Transfer DAO" as TRANS_DAO
entity "Notification DAO" as NOTIFY_DAO
database "Central Store" as DB

box "Financial Service Providers" #LightBlue
	participant DFSP1
	participant DFSP2
end box

box "ML API Adapter Service" #LightGreen
	participant MLAPI
	participant NOTIFY_HANDLER
end box

box "Central Service" #LightYellow
    participant CSAPI
	participant TOPIC_PREPARE_DFSP1
    participant PREP_HANDLER
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TRANS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant EVENT_DAO
    participant TRANS_DAO
    participant NOTIFY_DAO
    participant DB
end box

' start flow
alt DFSP1 sends a Prepare Transfer request to DFSP2
    activate MLAPI
    DFSP1 -> MLAPI: POST - http://transfers
    note right of MLAPI #yellow
        Message:
        {
            id: <transferMessage.id>
            from: http://ledger/dfsp1,
            to: http://ledger/dfsp2,
            type: application/json
            content: <transferMessage>,
            metadata: {
                event: {
                    id: <uuid>,
                    type: prepare,
                    action: prepare,
                    createdAt: <timestamp>
                }
            }
        }
    end note
    MLAPI -> TOPIC_PREPARE_DFSP1: Routes & Publishes Prepare event for DFSP1
    TOPIC_PREPARE_DFSP1 <-> TOPIC_PREPARE_DFSP1: Ensures that event is replicated as configured (ACKS=all)
    TOPIC_PREPARE_DFSP1 -> MLAPI: Responds replication acknoledgements have been received
    MLAPI -> DFSP1: Respond HTTP - 202 (Accepted)
    deactivate MLAPI
    activate PREP_HANDLER
    TOPIC_PREPARE_DFSP1 -> PREP_HANDLER: Consumes Prepare event message for DFSP1
    PREP_HANDLER <-> PREP_HANDLER: Validates from - DFSP1
    PREP_HANDLER <-> PREP_HANDLER: Validates to - DFSP2
    PREP_HANDLER <-> PREP_HANDLER: Validates message signature
    note right of PREP_HANDLER #yellow
        Message:
        {
            id: <transferMessage.id>
            from: http://ledger/dfsp1,
            to: http://ledger/dfsp2,
            type: application/json
            content: <transferMessage>,
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: position,
                    action: prepare,
                    createdAt: <timestamp>
                }
            }
        }
    end note
    PREP_HANDLER -> TOPIC_POSITION_DFSP1: Routes & Publishes Position event for DFSP1
    deactivate PREP_HANDLER
    activate POS_HANDLER
    TOPIC_POSITION_DFSP1 -> POS_HANDLER: Consumes Position event message for DFSP1
    POS_HANDLER -> POS_DAO: Request latest position from DB for DFSP1
    POS_DAO <-> DB: Retrieves latest position from DB for DFSP1
    POS_DAO -> POS_HANDLER: Return success
    POS_HANDLER <-> POS_HANDLER: Calculates latest position by decrementing transfer for prepare
    POS_HANDLER -> POS_DAO: Request to persist latest position for DFSP1
    POS_DAO <-> DB: Persists latest position to DB for DFSP1
    POS_DAO -> POS_HANDLER: return success
    POS_HANDLER -> EVENT_DAO: Request to persist event information
    EVENT_DAO <-> DB: Persist event information
    EVENT_DAO -> POS_HANDLER: return success
    note right of POS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.id>
            from: http://ledger/dfsp1,
            to: http://ledger/dfsp2,
            type: application/json
            content: <transferMessage>,
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: transfer,
                    action: prepare,
                    createdAt: <timestamp>
                }
            }
        }
    end note
    POS_HANDLER -> TOPIC_TRANSFERS: Publishes Transfer event
    deactivate POS_HANDLER
    deactivate TRANS_HANDLER
    TOPIC_TRANSFERS -> TRANS_HANDLER: Consumes Transfer event
    TRANS_HANDLER -> TRANS_DAO: Request to Transfer status to DB
    TRANS_DAO <-> DB: return success
    TRANS_DAO -> TRANS_HANDLER: Persists Transfer status to DB
    note right of TRANS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.id>
            from: http://ledger/dfsp1,
            to: http://ledger/dfsp1,
            type: application/json
            content: <transferResponseMessage>,
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: notification,
                    action: prepare,
                    createdAt: <timestamp>
                }
            }
        }
    end note
    TRANS_HANDLER -> TOPIC_NOTIFICATIONS: Publishes Notifications event for DFSP1
    note right of TRANS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.id>
            from: http://ledger/dfsp1,
            to: http://ledger/dfsp2,
            type: application/json
            content: <transferResponseMessage>,
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: notification,
                    action: prepare,
                    createdAt: <timestamp>
                }
            }
        }
    end note
    TRANS_HANDLER -> TOPIC_NOTIFICATIONS: Publishes Notifications event for DFSP2
    deactivate TRANS_HANDLER
    activate NOTIFY_HANDLER
    TOPIC_NOTIFICATIONS -> NOTIFY_HANDLER: Consumes Notifications event
    NOTIFY_HANDLER -> CSAPI: Requests Notification details for DFSP1 - GET - HTTP://notifications/DFPS1
    CSAPI <-> NOTIFY_DAO: Fetches Notifications details for DFSP1
    CSAPI -> NOTIFY_HANDLER: Returns Notifications details for DFSP1
    NOTIFY_HANDLER -> DFSP1: HTTP Callback with Prepare result to DFSP1
    NOTIFY_HANDLER -> CSAPI: Requests Notification details for DFSP2 - GET - HTTP://notifications/DFPS2
    CSAPI <-> NOTIFY_DAO: Fetches Notifications details for DFSP2
    CSAPI -> NOTIFY_HANDLER: Returns Notifications details for DFSP2
    NOTIFY_HANDLER -> DFSP2: HTTP Callback with Prepare result to DFSP2
    deactivate NOTIFY_HANDLER
end
@enduml

PlantUML version 1.2017.18(Fri Oct 06 18:56:32 SAST 2017)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_152-b16
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>