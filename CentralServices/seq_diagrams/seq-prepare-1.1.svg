<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4066px" preserveAspectRatio="none" style="width:4572px;height:4066px;" version="1.1" viewBox="0 0 4572 4066" width="4572px" zoomAndPan="magnify"><defs><filter height="300%" id="f7igzciw2mn0r" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="385" x="2094.5" y="23.5352">1.1 DFSP1 sends a Prepare Transfer request to DFSP2</text><rect fill="#ADD8E6" height="4021.3594" style="stroke: #A80036; stroke-width: 1.0;" width="186" x="4" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="7" y="47.0566">Financial Service Providers</text><rect fill="#90EE90" height="4021.3594" style="stroke: #A80036; stroke-width: 1.0;" width="596.5" x="286.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="506.25" y="47.0566">ML API Adapter Service</text><rect fill="#FFFFE0" height="4021.3594" style="stroke: #A80036; stroke-width: 1.0;" width="3332.5" x="1222.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="2838.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f7igzciw2mn0r)" height="1092.6328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="340.5" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f7igzciw2mn0r)" height="381.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="757.5" y="3563.0117"/><rect fill="#FFFFFF" filter="url(#f7igzciw2mn0r)" height="703.627" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1833.5" y="1239.9199"/><rect fill="#FFFFFF" filter="url(#f7igzciw2mn0r)" height="752.5586" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2642.5" y="1943.5469"/><rect fill="#FFFFFF" filter="url(#f7igzciw2mn0r)" height="3798.0723" style="stroke: #000000; stroke-width: 2.0;" width="4528" x="33" y="154.2871"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="67" x2="67" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="126" x2="126" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="345.5" x2="345.5" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="762" x2="762" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1293.5" x2="1293.5" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1454.5" x2="1454.5" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1838.5" x2="1838.5" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2313.5" x2="2313.5" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2647.5" x2="2647.5" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3264.5" x2="3264.5" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3470" x2="3470" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3765" x2="3765" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3897" x2="3897" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3994" x2="3994" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="4092" x2="4092" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="4212" x2="4212" y1="137.2871" y2="3969.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="4503" x2="4503" y1="137.2871" y2="3969.3594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="43" y="134.334">DFSP1</text><ellipse cx="67.5" cy="63.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M67.5,71.7988 L67.5,98.7988 M54.5,79.7988 L80.5,79.7988 M67.5,98.7988 L54.5,113.7988 M67.5,98.7988 L80.5,113.7988 " fill="#FEFECE" filter="url(#f7igzciw2mn0r)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="43" y="3981.8945">DFSP1</text><ellipse cx="67.5" cy="3994.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M67.5,4002.8477 L67.5,4029.8477 M54.5,4010.8477 L80.5,4010.8477 M67.5,4029.8477 L54.5,4044.8477 M67.5,4029.8477 L80.5,4044.8477 " fill="#FEFECE" filter="url(#f7igzciw2mn0r)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="102" y="134.334">DFSP2</text><ellipse cx="126.5" cy="63.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M126.5,71.7988 L126.5,98.7988 M113.5,79.7988 L139.5,79.7988 M126.5,98.7988 L113.5,113.7988 M126.5,98.7988 L139.5,113.7988 " fill="#FEFECE" filter="url(#f7igzciw2mn0r)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="102" y="3981.8945">DFSP2</text><ellipse cx="126.5" cy="3994.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M126.5,4002.8477 L126.5,4029.8477 M113.5,4010.8477 L139.5,4010.8477 M126.5,4029.8477 L113.5,4044.8477 M126.5,4029.8477 L139.5,4044.8477 " fill="#FEFECE" filter="url(#f7igzciw2mn0r)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="290.5" y="134.334">ML API Adapter</text><path d="M325,92.7988 L325,116.7988 M325,104.7988 L342,104.7988 " fill="#FEFECE" filter="url(#f7igzciw2mn0r)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354" cy="104.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="290.5" y="3981.8945">ML API Adapter</text><path d="M325,3988.8477 L325,4012.8477 M325,4000.8477 L342,4000.8477 " fill="#FEFECE" filter="url(#f7igzciw2mn0r)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354" cy="4000.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="227" x="646" y="134.334">ML API Notification Event Handler</text><ellipse cx="762.5" cy="104.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="758.5,92.7988,764.5,87.7988,762.5,92.7988,764.5,97.7988,758.5,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="227" x="646" y="3981.8945">ML API Notification Event Handler</text><ellipse cx="762.5" cy="4000.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="758.5,3988.8477,764.5,3983.8477,762.5,3988.8477,764.5,3993.8477,758.5,3988.8477" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128" x="1226.5" y="134.334">Central Service API</text><path d="M1273,92.7988 L1273,116.7988 M1273,104.7988 L1290,104.7988 " fill="#FEFECE" filter="url(#f7igzciw2mn0r)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="1302" cy="104.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128" x="1226.5" y="3981.8945">Central Service API</text><path d="M1273,3988.8477 L1273,4012.8477 M1273,4000.8477 L1290,4000.8477 " fill="#FEFECE" filter="url(#f7igzciw2mn0r)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="1302" cy="4000.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="1374.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="1370.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="1377.5" y="122.334">Prepare-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="1374.5" y="3968.3594"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="1370.5" y="3972.3594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="1377.5" y="3992.8945">Prepare-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="1759.5" y="134.334">Prepare Event Handler</text><ellipse cx="1838.5" cy="104.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1834.5,92.7988,1840.5,87.7988,1838.5,92.7988,1840.5,97.7988,1834.5,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="1759.5" y="3981.8945">Prepare Event Handler</text><ellipse cx="1838.5" cy="4000.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1834.5,3988.8477,1840.5,3983.8477,1838.5,3988.8477,1840.5,3993.8477,1834.5,3988.8477" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="2232.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="2228.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="2235.5" y="122.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="2232.5" y="3968.3594"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="2228.5" y="3972.3594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="2235.5" y="3992.8945">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="2567.5" y="134.334">Position Event Handler</text><ellipse cx="2647.5" cy="104.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2643.5,92.7988,2649.5,87.7988,2647.5,92.7988,2649.5,97.7988,2643.5,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="2567.5" y="3981.8945">Position Event Handler</text><ellipse cx="2647.5" cy="4000.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2643.5,3988.8477,2649.5,3983.8477,2647.5,3988.8477,2649.5,3993.8477,2643.5,3988.8477" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="3205.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="3201.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="3208.5" y="122.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="3205.5" y="3968.3594"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="3201.5" y="3972.3594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="3208.5" y="3992.8945">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="3389" y="134.334">Transfer Event Handler</text><ellipse cx="3470.5" cy="104.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="3466.5,92.7988,3472.5,87.7988,3470.5,92.7988,3472.5,97.7988,3466.5,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="3389" y="3981.8945">Transfer Event Handler</text><ellipse cx="3470.5" cy="4000.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="3466.5,3988.8477,3472.5,3983.8477,3470.5,3988.8477,3472.5,3993.8477,3466.5,3988.8477" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="3696" y="97.7988"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="3692" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="3699" y="122.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="3696" y="3968.3594"/><rect fill="#FEFECE" filter="url(#f7igzciw2mn0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="3692" y="3972.3594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="3699" y="3992.8945">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="3849" y="134.334">Position DAO</text><ellipse cx="3897" cy="104.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3885" x2="3909" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="3849" y="3981.8945">Position DAO</text><ellipse cx="3897" cy="4000.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3885" x2="3909" y1="4014.8477" y2="4014.8477"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="3955" y="134.334">Event DAO</text><ellipse cx="3994" cy="104.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3982" x2="4006" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="3955" y="3981.8945">Event DAO</text><ellipse cx="3994" cy="4000.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="3982" x2="4006" y1="4014.8477" y2="4014.8477"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="4043" y="134.334">Transfer DAO</text><ellipse cx="4092.5" cy="104.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="4080.5" x2="4104.5" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="4043" y="3981.8945">Transfer DAO</text><ellipse cx="4092.5" cy="4000.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="4080.5" x2="4104.5" y1="4014.8477" y2="4014.8477"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="4152" y="134.334">Notification DAO</text><ellipse cx="4212" cy="104.7988" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="4200" x2="4224" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="4152" y="3981.8945">Notification DAO</text><ellipse cx="4212" cy="4000.8477" fill="#FEFECE" filter="url(#f7igzciw2mn0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="4200" x2="4224" y1="4014.8477" y2="4014.8477"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="4455" y="134.334">Central Store</text><path d="M4485,84.7988 C4485,74.7988 4503,74.7988 4503,74.7988 C4503,74.7988 4521,74.7988 4521,84.7988 L4521,110.7988 C4521,120.7988 4503,120.7988 4503,120.7988 C4503,120.7988 4485,120.7988 4485,110.7988 L4485,84.7988 " fill="#FEFECE" filter="url(#f7igzciw2mn0r)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M4485,84.7988 C4485,94.7988 4503,94.7988 4503,94.7988 C4503,94.7988 4521,94.7988 4521,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="4455" y="3981.8945">Central Store</text><path d="M4485,3994.8477 C4485,3984.8477 4503,3984.8477 4503,3984.8477 C4503,3984.8477 4521,3984.8477 4521,3994.8477 L4521,4020.8477 C4521,4030.8477 4503,4030.8477 4503,4030.8477 C4503,4030.8477 4485,4030.8477 4485,4020.8477 L4485,3994.8477 " fill="#FEFECE" filter="url(#f7igzciw2mn0r)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M4485,3994.8477 C4485,4004.8477 4503,4004.8477 4503,4004.8477 C4503,4004.8477 4521,4004.8477 4521,3994.8477 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f7igzciw2mn0r)" height="1092.6328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="340.5" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f7igzciw2mn0r)" height="381.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="757.5" y="3563.0117"/><rect fill="#FFFFFF" filter="url(#f7igzciw2mn0r)" height="703.627" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1833.5" y="1239.9199"/><rect fill="#FFFFFF" filter="url(#f7igzciw2mn0r)" height="752.5586" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2642.5" y="1943.5469"/><rect fill="none" height="3798.0723" style="stroke: #000000; stroke-width: 2.0;" width="4528" x="33" y="154.2871"/><polygon fill="#EEEEEE" points="33,154.2871,95,154.2871,95,161.2871,85,171.2871,33,171.2871,33,154.2871" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="48" y="167.8555">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="286" x="110" y="166.9219">[DFSP1 sends a Prepare Transfer request to DFSP2]</text><polygon fill="#FFFF00" filter="url(#f7igzciw2mn0r)" points="72,176.5977,72,706.5977,413,706.5977,413,186.5977,403,176.5977,72,176.5977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="403" x2="403" y1="176.5977" y2="186.5977"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="413" x2="403" y1="186.5977" y2="186.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="78" y="194.166">Headers - transferHeaders: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="94" y="209.4766">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="94" y="224.7871">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="94" y="240.0977">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="94" y="255.4082">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="94" y="270.7188">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="94" y="286.0293">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="94" y="301.3398">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="94" y="316.6504">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="94" y="331.9609">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="94" y="347.2715">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="362.582">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="82" y="377.8926"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="78" y="393.2031">Payload - transferMessage:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="408.5137">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="94" y="423.8242">"transferId": &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="94" y="439.1348">"payeeFsp": dfsp1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="94" y="454.4453">"payerFsp": dfsp1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="94" y="469.7559">"amount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="110" y="485.0664">"currency": "AED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="110" y="500.377">"amount": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="94" y="515.6875">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="94" y="530.998">"ilpPacket": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="94" y="546.3086">"condition": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="94" y="561.6191">"expiration": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="94" y="576.9297">"extensionList": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="110" y="592.2402">"extension": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="607.5508">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="126" y="622.8613">"key": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="126" y="638.1719">"value": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="653.4824">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="668.793">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="684.1035">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="699.4141">}</text><polygon fill="#A80036" points="328.5,733.1563,338.5,737.1563,328.5,741.1563,332.5,737.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="67.5" x2="334.5" y1="737.1563" y2="737.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="74.5" y="732.7246">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="87.5" y="732.7246">POST - http://transfers</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="350.5" x2="392.5" y1="766.7773" y2="766.7773"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="392.5" x2="392.5" y1="766.7773" y2="779.7773"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351.5" x2="392.5" y1="779.7773" y2="779.7773"/><polygon fill="#A80036" points="361.5,775.7773,351.5,779.7773,361.5,783.7773,357.5,779.7773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="357.5" y="762.0352">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="370.5" y="762.0352">validates incoming token, and the originator matches DFSP1</text><polygon fill="#FFFF00" filter="url(#f7igzciw2mn0r)" points="355,792.7773,355,1108.7773,617,1108.7773,617,802.7773,607,792.7773,355,792.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="607" x2="607" y1="792.7773" y2="802.7773"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617" x2="607" y1="802.7773" y2="802.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="361" y="810.3457">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="361" y="825.6563">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="377" y="840.9668">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="377" y="856.2773">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="377" y="871.5879">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="377" y="886.8984">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="377" y="902.209">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="393" y="917.5195">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="393" y="932.8301">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="377" y="948.1406">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="377" y="963.4512">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="393" y="978.7617">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="409" y="994.0723">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="409" y="1009.3828">type: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="409" y="1024.6934">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="409" y="1040.0039">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="409" y="1055.3145">status: success</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="1070.625">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="1085.9355">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="361" y="1101.2461">}</text><polygon fill="#A80036" points="1442.5,1134.9883,1452.5,1138.9883,1442.5,1142.9883,1446.5,1138.9883" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="350.5" x2="1448.5" y1="1138.9883" y2="1138.9883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="357.5" y="1134.5566">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="370.5" y="1134.5566">Routes &amp; Publishes Prepare event for DFSP1</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1454.5" x2="1496.5" y1="1168.6094" y2="1168.6094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1496.5" x2="1496.5" y1="1168.6094" y2="1181.6094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="1496.5" y1="1181.6094" y2="1181.6094"/><polygon fill="#A80036" points="1465.5,1177.6094,1455.5,1181.6094,1465.5,1185.6094,1461.5,1181.6094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1461.5" y="1163.8672">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="1474.5" y="1163.8672">Ensures that event is replicated as configured (ACKS=all)</text><polygon fill="#A80036" points="361.5,1206.6094,351.5,1210.6094,361.5,1214.6094,357.5,1210.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355.5" x2="1453.5" y1="1210.6094" y2="1210.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="367.5" y="1206.1777">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="380.5" y="1206.1777">Responds replication acknoledgements have been received</text><polygon fill="#A80036" points="78.5,1235.9199,68.5,1239.9199,78.5,1243.9199,74.5,1239.9199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="344.5" y1="1239.9199" y2="1239.9199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="84.5" y="1235.4883">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="97.5" y="1235.4883">Respond HTTP - 202 (Accepted)</text><polygon fill="#A80036" points="1821.5,1265.2305,1831.5,1269.2305,1821.5,1273.2305,1825.5,1269.2305" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1454.5" x2="1827.5" y1="1269.2305" y2="1269.2305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1461.5" y="1264.7988">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="1474.5" y="1264.7988">Consumes Prepare event message for DFSP1</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1843.5" x2="1885.5" y1="1298.8516" y2="1298.8516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1885.5" x2="1885.5" y1="1298.8516" y2="1311.8516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1844.5" x2="1885.5" y1="1311.8516" y2="1311.8516"/><polygon fill="#A80036" points="1854.5,1307.8516,1844.5,1311.8516,1854.5,1315.8516,1850.5,1311.8516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1850.5" y="1294.1094">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1863.5" y="1294.1094">Validates from - DFSP1</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1843.5" x2="1885.5" y1="1341.1621" y2="1341.1621"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1885.5" x2="1885.5" y1="1341.1621" y2="1354.1621"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1844.5" x2="1885.5" y1="1354.1621" y2="1354.1621"/><polygon fill="#A80036" points="1854.5,1350.1621,1844.5,1354.1621,1854.5,1358.1621,1850.5,1354.1621" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1850.5" y="1336.4199">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="1863.5" y="1336.4199">Validates to - DFSP2</text><polygon fill="#A80036" points="4080.5,1379.1621,4090.5,1383.1621,4080.5,1387.1621,4084.5,1383.1621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1843.5" x2="4086.5" y1="1383.1621" y2="1383.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1850.5" y="1378.7305">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="1872.5" y="1378.7305">Request to retrieve Transfer (if it exists)</text><polygon fill="#A80036" points="4103.5,1408.4727,4093.5,1412.4727,4103.5,1416.4727,4099.5,1412.4727" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="4491,1408.4727,4501,1412.4727,4491,1416.4727,4495,1412.4727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="4097.5" x2="4497" y1="1412.4727" y2="1412.4727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="4109.5" y="1408.041">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="4131.5" y="1408.041">return Transfer if it exists</text><polygon fill="#A80036" points="1854.5,1437.7832,1844.5,1441.7832,1854.5,1445.7832,1850.5,1441.7832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1848.5" x2="4091.5" y1="1441.7832" y2="1441.7832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1860.5" y="1437.3516">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="1882.5" y="1437.3516">return Transfer if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1843.5" x2="1885.5" y1="1471.4043" y2="1471.4043"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1885.5" x2="1885.5" y1="1471.4043" y2="1484.4043"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1844.5" x2="1885.5" y1="1484.4043" y2="1484.4043"/><polygon fill="#A80036" points="1854.5,1480.4043,1844.5,1484.4043,1854.5,1488.4043,1850.5,1484.4043" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1850.5" y="1466.6621">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="1872.5" y="1466.6621">Validates duplicate Check</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1843.5" x2="1885.5" y1="1513.7148" y2="1513.7148"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1885.5" x2="1885.5" y1="1513.7148" y2="1526.7148"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1844.5" x2="1885.5" y1="1526.7148" y2="1526.7148"/><polygon fill="#A80036" points="1854.5,1522.7148,1844.5,1526.7148,1854.5,1530.7148,1850.5,1526.7148" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1850.5" y="1508.9727">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="1872.5" y="1508.9727">Validates crypto-condition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1843.5" x2="1885.5" y1="1556.0254" y2="1556.0254"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1885.5" x2="1885.5" y1="1556.0254" y2="1569.0254"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1844.5" x2="1885.5" y1="1569.0254" y2="1569.0254"/><polygon fill="#A80036" points="1854.5,1565.0254,1844.5,1569.0254,1854.5,1573.0254,1850.5,1569.0254" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1850.5" y="1551.2832">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="429" x="1872.5" y="1551.2832">Validates message signature (to be confirmed in future requirement)</text><polygon fill="#FFFF00" filter="url(#f7igzciw2mn0r)" points="1848,1582.0254,1848,1913.0254,2110,1913.0254,2110,1592.0254,2100,1582.0254,1848,1582.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2100" x2="2100" y1="1582.0254" y2="1592.0254"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2110" x2="2100" y1="1592.0254" y2="1592.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="1854" y="1599.5938">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1854" y="1614.9043">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="1870" y="1630.2148">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="1870" y="1645.5254">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="1870" y="1660.8359">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1870" y="1676.1465">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="1870" y="1691.457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="1886" y="1706.7676">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="1886" y="1722.0781">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1870" y="1737.3887">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="1870" y="1752.6992">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1886" y="1768.0098">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="1902" y="1783.3203">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="1902" y="1798.6309">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="1902" y="1813.9414">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="1902" y="1829.252">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="1902" y="1844.5625">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1902" y="1859.873">status: success</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1886" y="1875.1836">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1870" y="1890.4941">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1854" y="1905.8047">}</text><polygon fill="#A80036" points="2301.5,1939.5469,2311.5,1943.5469,2301.5,1947.5469,2305.5,1943.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1838.5" x2="2307.5" y1="1943.5469" y2="1943.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1845.5" y="1939.1152">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="1867.5" y="1939.1152">Routes &amp; Publishes Position event for DFSP1</text><polygon fill="#A80036" points="2630.5,1968.8574,2640.5,1972.8574,2630.5,1976.8574,2634.5,1972.8574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2313.5" x2="2636.5" y1="1972.8574" y2="1972.8574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2320.5" y="1968.4258">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="2342.5" y="1968.4258">Consumes Position event message for DFSP1</text><polygon fill="#A80036" points="3885,1998.168,3895,2002.168,3885,2006.168,3889,2002.168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2652.5" x2="3891" y1="2002.168" y2="2002.168"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2659.5" y="1997.7363">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="2681.5" y="1997.7363">Request latest position from DB for DFSP1</text><polygon fill="#A80036" points="3908,2027.4785,3898,2031.4785,3908,2035.4785,3904,2031.4785" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="4491,2027.4785,4501,2031.4785,4491,2035.4785,4495,2031.4785" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3902" x2="4497" y1="2031.4785" y2="2031.4785"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3914" y="2027.0469">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="3936" y="2027.0469">Retrieves latest position from DB for DFSP1</text><polygon fill="#A80036" points="2663.5,2056.7891,2653.5,2060.7891,2663.5,2064.7891,2659.5,2060.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2657.5" x2="3896" y1="2060.7891" y2="2060.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2669.5" y="2056.3574">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="2691.5" y="2056.3574">Return success</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2652.5" x2="2694.5" y1="2090.4102" y2="2090.4102"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2694.5" x2="2694.5" y1="2090.4102" y2="2103.4102"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2653.5" x2="2694.5" y1="2103.4102" y2="2103.4102"/><polygon fill="#A80036" points="2663.5,2099.4102,2653.5,2103.4102,2663.5,2107.4102,2659.5,2103.4102" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2659.5" y="2085.668">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="2681.5" y="2085.668">Calculates latest position (lpos) by incrementing transfer for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2652.5" x2="2694.5" y1="2132.7207" y2="2132.7207"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2694.5" x2="2694.5" y1="2132.7207" y2="2145.7207"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2653.5" x2="2694.5" y1="2145.7207" y2="2145.7207"/><polygon fill="#A80036" points="2663.5,2141.7207,2653.5,2145.7207,2663.5,2149.7207,2659.5,2145.7207" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2659.5" y="2127.9785">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="2681.5" y="2127.9785">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="3885,2170.7207,3895,2174.7207,3885,2178.7207,3889,2174.7207" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2652.5" x2="3891" y1="2174.7207" y2="2174.7207"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2659.5" y="2170.2891">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="2681.5" y="2170.2891">Request to persist latest position for DFSP1</text><polygon fill="#A80036" points="3908,2200.0313,3898,2204.0313,3908,2208.0313,3904,2204.0313" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="4491,2200.0313,4501,2204.0313,4491,2208.0313,4495,2204.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3902" x2="4497" y1="2204.0313" y2="2204.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3914" y="2199.5996">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="3936" y="2199.5996">Persists latest position to DB for DFSP1</text><polygon fill="#A80036" points="2663.5,2229.3418,2653.5,2233.3418,2663.5,2237.3418,2659.5,2233.3418" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2657.5" x2="3896" y1="2233.3418" y2="2233.3418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2669.5" y="2228.9102">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="2691.5" y="2228.9102">return success</text><polygon fill="#A80036" points="3982,2258.6523,3992,2262.6523,3982,2266.6523,3986,2262.6523" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2652.5" x2="3988" y1="2262.6523" y2="2262.6523"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2659.5" y="2258.2207">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="2681.5" y="2258.2207">Request to persist event information</text><polygon fill="#A80036" points="4005,2287.9629,3995,2291.9629,4005,2295.9629,4001,2291.9629" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="4491,2287.9629,4501,2291.9629,4491,2295.9629,4495,2291.9629" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3999" x2="4497" y1="2291.9629" y2="2291.9629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="4011" y="2287.5313">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="4033" y="2287.5313">Persist event information</text><polygon fill="#A80036" points="2663.5,2317.2734,2653.5,2321.2734,2663.5,2325.2734,2659.5,2321.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2657.5" x2="3993" y1="2321.2734" y2="2321.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2669.5" y="2316.8418">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="2691.5" y="2316.8418">return success</text><polygon fill="#FFFF00" filter="url(#f7igzciw2mn0r)" points="2657,2334.584,2657,2665.584,2919,2665.584,2919,2344.584,2909,2334.584,2657,2334.584" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2909" x2="2909" y1="2334.584" y2="2344.584"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2919" x2="2909" y1="2344.584" y2="2344.584"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="2663" y="2352.1523">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2663" y="2367.4629">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="2679" y="2382.7734">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="2679" y="2398.084">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="2679" y="2413.3945">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="2679" y="2428.7051">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="2679" y="2444.0156">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="2695" y="2459.3262">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="2695" y="2474.6367">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="2679" y="2489.9473">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="2679" y="2505.2578">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="2695" y="2520.5684">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="2711" y="2535.8789">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="2711" y="2551.1895">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="2711" y="2566.5">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="2711" y="2581.8105">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="2711" y="2597.1211">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="2711" y="2612.4316">status: success</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2695" y="2627.7422">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2679" y="2643.0527">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="2663" y="2658.3633">}</text><polygon fill="#A80036" points="3252.5,2692.1055,3262.5,2696.1055,3252.5,2700.1055,3256.5,2696.1055" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2647.5" x2="3258.5" y1="2696.1055" y2="2696.1055"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2654.5" y="2691.6738">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="2676.5" y="2691.6738">Publishes Transfer event</text><polygon fill="#A80036" points="3458.5,2721.416,3468.5,2725.416,3458.5,2729.416,3462.5,2725.416" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3264.5" x2="3464.5" y1="2725.416" y2="2725.416"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3271.5" y="2720.9844">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="3293.5" y="2720.9844">Consumes Transfer event</text><polygon fill="#A80036" points="4080.5,2750.7266,4090.5,2754.7266,4080.5,2758.7266,4084.5,2754.7266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3470.5" x2="4086.5" y1="2754.7266" y2="2754.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3477.5" y="2750.2949">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="3499.5" y="2750.2949">Request to Transfer status to DB</text><polygon fill="#A80036" points="4103.5,2780.0371,4093.5,2784.0371,4103.5,2788.0371,4099.5,2784.0371" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="4491,2780.0371,4501,2784.0371,4491,2788.0371,4495,2784.0371" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="4097.5" x2="4497" y1="2784.0371" y2="2784.0371"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="4109.5" y="2779.6055">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="4131.5" y="2779.6055">return success</text><polygon fill="#A80036" points="3481.5,2809.3477,3471.5,2813.3477,3481.5,2817.3477,3477.5,2813.3477" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3475.5" x2="4091.5" y1="2813.3477" y2="2813.3477"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3487.5" y="2808.916">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="3509.5" y="2808.916">Persists Transfer status to DB</text><polygon fill="#FFFF00" filter="url(#f7igzciw2mn0r)" points="3475,2826.6582,3475,3157.6582,3737,3157.6582,3737,2836.6582,3727,2826.6582,3475,2826.6582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3727" x2="3727" y1="2826.6582" y2="2836.6582"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3737" x2="3727" y1="2836.6582" y2="2836.6582"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="3481" y="2844.2266">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="3481" y="2859.5371">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="3497" y="2874.8477">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="3497" y="2890.1582">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="3497" y="2905.4688">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="3497" y="2920.7793">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="3497" y="2936.0898">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="3513" y="2951.4004">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="3513" y="2966.7109">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="3497" y="2982.0215">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="3497" y="2997.332">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="3513" y="3012.6426">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="3529" y="3027.9531">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="3529" y="3043.2637">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="3529" y="3058.5742">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="3529" y="3073.8848">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="3529" y="3089.1953">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="3529" y="3104.5059">status: success</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="3513" y="3119.8164">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="3497" y="3135.127">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="3481" y="3150.4375">}</text><polygon fill="#A80036" points="3753.5,3184.1797,3763.5,3188.1797,3753.5,3192.1797,3757.5,3188.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3470.5" x2="3759.5" y1="3188.1797" y2="3188.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3477.5" y="3183.748">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="3499.5" y="3183.748">Publishes Notifications event for DFSP1</text><polygon fill="#FFFF00" filter="url(#f7igzciw2mn0r)" points="3475,3201.4902,3475,3532.4902,3737,3532.4902,3737,3211.4902,3727,3201.4902,3475,3201.4902" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3727" x2="3727" y1="3201.4902" y2="3211.4902"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3737" x2="3727" y1="3211.4902" y2="3211.4902"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="3481" y="3219.0586">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="3481" y="3234.3691">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="3497" y="3249.6797">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="3497" y="3264.9902">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="3497" y="3280.3008">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="3497" y="3295.6113">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="3497" y="3310.9219">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="3513" y="3326.2324">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="3513" y="3341.543">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="3497" y="3356.8535">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="3497" y="3372.1641">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="3513" y="3387.4746">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="3529" y="3402.7852">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="3529" y="3418.0957">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="3529" y="3433.4063">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="3529" y="3448.7168">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="3529" y="3464.0273">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="3529" y="3479.3379">status: success</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="3513" y="3494.6484">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="3497" y="3509.959">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="3481" y="3525.2695">}</text><polygon fill="#A80036" points="3753.5,3559.0117,3763.5,3563.0117,3753.5,3567.0117,3757.5,3563.0117" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3470.5" x2="3759.5" y1="3563.0117" y2="3563.0117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3477.5" y="3558.5801">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="3499.5" y="3558.5801">Publishes Notifications event for DFSP2</text><polygon fill="#A80036" points="778.5,3588.3223,768.5,3592.3223,778.5,3596.3223,774.5,3592.3223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="772.5" x2="3764.5" y1="3592.3223" y2="3592.3223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="784.5" y="3587.8906">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="806.5" y="3587.8906">Consumes Notifications event</text><polygon fill="#A80036" points="1281.5,3617.6328,1291.5,3621.6328,1281.5,3625.6328,1285.5,3621.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767.5" x2="1287.5" y1="3621.6328" y2="3621.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="774.5" y="3617.2012">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="480" x="796.5" y="3617.2012">Requests Notification details for DFSP1 - GET - HTTP://notifications/DFPS1</text><polygon fill="#A80036" points="4200,3646.9434,4210,3650.9434,4200,3654.9434,4204,3650.9434" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1293.5" x2="4206" y1="3650.9434" y2="3650.9434"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1300.5" y="3646.5117">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="1322.5" y="3646.5117">Fetches Notifications details for DFSP1</text><polygon fill="#A80036" points="4223,3676.2539,4213,3680.2539,4223,3684.2539,4219,3680.2539" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="4491,3676.2539,4501,3680.2539,4491,3684.2539,4495,3680.2539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="4217" x2="4497" y1="3680.2539" y2="3680.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="4229" y="3675.8223">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="4251" y="3675.8223">Fetches Notifications details for DFSP1</text><polygon fill="#A80036" points="1304.5,3705.5645,1294.5,3709.5645,1304.5,3713.5645,1300.5,3709.5645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1298.5" x2="4211" y1="3709.5645" y2="3709.5645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1310.5" y="3705.1328">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="1332.5" y="3705.1328">Returns Notifications details for DFSP1</text><polygon fill="#A80036" points="778.5,3734.875,768.5,3738.875,778.5,3742.875,774.5,3738.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="772.5" x2="1292.5" y1="3738.875" y2="3738.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="784.5" y="3734.4434">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="806.5" y="3734.4434">Returns Notifications details for DFSP1</text><polygon fill="#A80036" points="78.5,3764.1855,68.5,3768.1855,78.5,3772.1855,74.5,3768.1855" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="756.5" y1="3768.1855" y2="3768.1855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="84.5" y="3763.7539">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="106.5" y="3763.7539">HTTP Callback with Prepare result to DFSP1</text><polygon fill="#A80036" points="1281.5,3793.4961,1291.5,3797.4961,1281.5,3801.4961,1285.5,3797.4961" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767.5" x2="1287.5" y1="3797.4961" y2="3797.4961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="774.5" y="3793.0645">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="480" x="796.5" y="3793.0645">Requests Notification details for DFSP2 - GET - HTTP://notifications/DFPS2</text><polygon fill="#A80036" points="1304.5,3822.8066,1294.5,3826.8066,1304.5,3830.8066,1300.5,3826.8066" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="4200,3822.8066,4210,3826.8066,4200,3830.8066,4204,3826.8066" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1298.5" x2="4206" y1="3826.8066" y2="3826.8066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1310.5" y="3822.375">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="1332.5" y="3822.375">Fetches Notifications details for DFSP2</text><polygon fill="#A80036" points="4223,3852.1172,4213,3856.1172,4223,3860.1172,4219,3856.1172" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="4491,3852.1172,4501,3856.1172,4491,3860.1172,4495,3856.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="4217" x2="4497" y1="3856.1172" y2="3856.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="4229" y="3851.6855">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="4251" y="3851.6855">Fetches Notifications details for DFSP1</text><polygon fill="#A80036" points="1304.5,3881.4277,1294.5,3885.4277,1304.5,3889.4277,1300.5,3885.4277" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1298.5" x2="4211" y1="3885.4277" y2="3885.4277"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1310.5" y="3880.9961">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="1332.5" y="3880.9961">Returns Notifications details for DFSP1</text><polygon fill="#A80036" points="778.5,3910.7383,768.5,3914.7383,778.5,3918.7383,774.5,3914.7383" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="772.5" x2="1292.5" y1="3914.7383" y2="3914.7383"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="784.5" y="3910.3066">47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="806.5" y="3910.3066">Returns Notifications details for DFSP2</text><polygon fill="#A80036" points="137.5,3940.0488,127.5,3944.0488,137.5,3948.0488,133.5,3944.0488" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="131.5" x2="761.5" y1="3944.0488" y2="3944.0488"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="143.5" y="3939.6172">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="165.5" y="3939.6172">HTTP Callback with Prepare result to DFSP2</text><!--
@startuml
' declate title
title 1.1 DFSP1 sends a Prepare Transfer request to DFSP2

autonumber

' Actor Keys:
'   boundary - APIs/Interfaces, etc
'   collections - Kafka Topics
'   control - Kafka Consumers
'   entity - Database Access Objects
'   database - Database Persistance Store

' declare actors
actor DFSP1
actor DFSP2
boundary "ML API Adapter" as MLAPI
control "ML API Notification Event Handler" as NOTIFY_HANDLER
boundary "Central Service API" as CSAPI
collections "Prepare-Topic-dfsp1" as TOPIC_PREPARE_DFSP1
control "Prepare Event Handler" as PREP_HANDLER
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
control "Transfer Event Handler" as TRANS_HANDLER
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
entity "Event DAO" as EVENT_DAO
entity "Transfer DAO" as TRANS_DAO
entity "Notification DAO" as NOTIFY_DAO
database "Central Store" as DB

box "Financial Service Providers" #LightBlue
	participant DFSP1
	participant DFSP2
end box

box "ML API Adapter Service" #LightGreen
	participant MLAPI
	participant NOTIFY_HANDLER
end box

box "Central Service" #LightYellow
    participant CSAPI
	participant TOPIC_PREPARE_DFSP1
    participant PREP_HANDLER
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TRANS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant EVENT_DAO
    participant TRANS_DAO
    participant NOTIFY_DAO
    participant DB
end box

' start flow
alt DFSP1 sends a Prepare Transfer request to DFSP2
    activate MLAPI
    note right of DFSP1 #yellow
        Headers - transferHeaders: {
            Content-Length: <Content-Length>,
            Content-Type: <Content-Type>,
            Date: <Date>,
            X-Forwarded-For: <X-Forwarded-For>,
            FSPIOP-Source: <FSPIOP-Source>,
            FSPIOP-Destination: <FSPIOP-Destination>,
            FSPIOP-Encryption: <FSPIOP-Encryption>,
            FSPIOP-Signature: <FSPIOP-Signature>,
            FSPIOP-URI: <FSPIOP-URI>,
            FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
        }

        Payload - transferMessage:
        {
            "transferId": <uuid>,
            "payeeFsp": dfsp1,
            "payerFsp": dfsp1,
            "amount": {
                "currency": "AED",
                "amount": "string"
            },
            "ilpPacket": "string",
            "condition": "string",
            "expiration": "string",
            "extensionList": {
                "extension": [
                {
                    "key": "string",
                    "value": "string"
                }
                ]
            }
        }
    end note
    DFSP1 -> MLAPI: POST - http://transfers
    MLAPI -> MLAPI: validates incoming token, and the originator matches DFSP1
    note right of MLAPI #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    type: prepare,
                    action: prepare,
                    createdAt: <timestamp>,
                    status: success
                }
            }
        }
    end note
    MLAPI -> TOPIC_PREPARE_DFSP1: Routes & Publishes Prepare event for DFSP1
    TOPIC_PREPARE_DFSP1 <-> TOPIC_PREPARE_DFSP1: Ensures that event is replicated as configured (ACKS=all)
    TOPIC_PREPARE_DFSP1 -> MLAPI: Responds replication acknoledgements have been received
    MLAPI -> DFSP1: Respond HTTP - 202 (Accepted)
    deactivate MLAPI
    activate PREP_HANDLER
    TOPIC_PREPARE_DFSP1 -> PREP_HANDLER: Consumes Prepare event message for DFSP1
    PREP_HANDLER <-> PREP_HANDLER: Validates from - DFSP1
    PREP_HANDLER <-> PREP_HANDLER: Validates to - DFSP2
    PREP_HANDLER -> TRANS_DAO: Request to retrieve Transfer (if it exists)
    TRANS_DAO <-> DB: return Transfer if it exists
    TRANS_DAO -> PREP_HANDLER: return Transfer if it exists
    PREP_HANDLER <-> PREP_HANDLER: Validates duplicate Check
    PREP_HANDLER <-> PREP_HANDLER: Validates crypto-condition
    PREP_HANDLER <-> PREP_HANDLER: Validates message signature (to be confirmed in future requirement)
    note right of PREP_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: position,
                    action: prepare,
                    createdAt: <timestamp>,
                    status: success
                }
            }
        }
    end note
    PREP_HANDLER -> TOPIC_POSITION_DFSP1: Routes & Publishes Position event for DFSP1
    deactivate PREP_HANDLER
    activate POS_HANDLER
    TOPIC_POSITION_DFSP1 -> POS_HANDLER: Consumes Position event message for DFSP1
    POS_HANDLER -> POS_DAO: Request latest position from DB for DFSP1
    POS_DAO <-> DB: Retrieves latest position from DB for DFSP1
    POS_DAO -> POS_HANDLER: Return success
    POS_HANDLER <-> POS_HANDLER: Calculates latest position (lpos) by incrementing transfer for prepare
    POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
    POS_HANDLER -> POS_DAO: Request to persist latest position for DFSP1
    POS_DAO <-> DB: Persists latest position to DB for DFSP1
    POS_DAO -> POS_HANDLER: return success
    POS_HANDLER -> EVENT_DAO: Request to persist event information
    EVENT_DAO <-> DB: Persist event information
    EVENT_DAO -> POS_HANDLER: return success
    note right of POS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: transfer,
                    action: prepare,
                    createdAt: <timestamp>,
                    status: success
                }
            }
        }
    end note
    POS_HANDLER -> TOPIC_TRANSFERS: Publishes Transfer event
    deactivate POS_HANDLER
    deactivate TRANS_HANDLER
    TOPIC_TRANSFERS -> TRANS_HANDLER: Consumes Transfer event
    TRANS_HANDLER -> TRANS_DAO: Request to Transfer status to DB
    TRANS_DAO <-> DB: return success
    TRANS_DAO -> TRANS_HANDLER: Persists Transfer status to DB
    note right of TRANS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payerFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: notification,
                    action: prepare,
                    createdAt: <timestamp>,
                    status: success
                }
            }
        }
    end note
    TRANS_HANDLER -> TOPIC_NOTIFICATIONS: Publishes Notifications event for DFSP1
    note right of TRANS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: notification,
                    action: prepare,
                    createdAt: <timestamp>,
                    status: success
                }
            }
        }
    end note
    TRANS_HANDLER -> TOPIC_NOTIFICATIONS: Publishes Notifications event for DFSP2
    deactivate TRANS_HANDLER
    activate NOTIFY_HANDLER
    TOPIC_NOTIFICATIONS -> NOTIFY_HANDLER: Consumes Notifications event
    NOTIFY_HANDLER -> CSAPI: Requests Notification details for DFSP1 - GET - HTTP://notifications/DFPS1
    CSAPI -> NOTIFY_DAO: Fetches Notifications details for DFSP1
    NOTIFY_DAO <-> DB: Fetches Notifications details for DFSP1
    NOTIFY_DAO -> CSAPI: Returns Notifications details for DFSP1
    CSAPI -> NOTIFY_HANDLER: Returns Notifications details for DFSP1
    NOTIFY_HANDLER -> DFSP1: HTTP Callback with Prepare result to DFSP1
    NOTIFY_HANDLER -> CSAPI: Requests Notification details for DFSP2 - GET - HTTP://notifications/DFPS2
    CSAPI <-> NOTIFY_DAO: Fetches Notifications details for DFSP2
    NOTIFY_DAO <-> DB: Fetches Notifications details for DFSP1
    NOTIFY_DAO -> CSAPI: Returns Notifications details for DFSP1
    CSAPI -> NOTIFY_HANDLER: Returns Notifications details for DFSP2
    NOTIFY_HANDLER -> DFSP2: HTTP Callback with Prepare result to DFSP2
    deactivate NOTIFY_HANDLER
end
@enduml

PlantUML version 1.2017.18(Fri Oct 06 18:56:32 SAST 2017)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_152-b16
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>