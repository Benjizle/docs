<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2574px" preserveAspectRatio="none" style="width:1840px;height:2574px;" version="1.1" viewBox="0 0 1840 2574" width="1840px" zoomAndPan="magnify"><defs><filter height="300%" id="f1jsveuzrtbp1m" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="361" x="740.5" y="23.5352">1.1.2. Position Handler Consume (single message)</text><rect fill="#FFFFE0" height="2529.123" style="stroke: #A80036; stroke-width: 1.0;" width="1757" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="847" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.5977"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="2339.5254" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="1419.1934"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="451.082"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="686.9453"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="1517.7695"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1516.5" y="869.498"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1516.5" y="1824.2539"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="480.3926"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="716.2559"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="898.8086"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="1547.0801"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="1853.5645"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="2347.8359" style="stroke: #000000; stroke-width: 2.0;" width="1816" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="879" x="330" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="2085.6621" style="stroke: #000000; stroke-width: 2.0;" width="1499" x="320" y="388.4609"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="404.416" style="stroke: #000000; stroke-width: 2.0;" width="1466" x="330" y="412.7715"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1479" x="330" y="831.1875"/><rect fill="#FFFFFF" height="1016.6191" style="stroke: none; stroke-width: 1.0;" width="1499" x="320" y="1457.5039"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="292.4844" style="stroke: #000000; stroke-width: 2.0;" width="1466" x="330" y="1479.459"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1479" x="330" y="1785.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="108" x2="108" y1="116.2871" y2="2498.123"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="420" x2="420" y1="116.2871" y2="2498.123"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1037" x2="1037" y1="116.2871" y2="2498.123"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1154" x2="1154" y1="116.2871" y2="2498.123"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1282" x2="1282" y1="116.2871" y2="2498.123"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1414" x2="1414" y1="116.2871" y2="2498.123"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1521" x2="1521" y1="116.2871" y2="2498.123"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1724" x2="1724" y1="116.2871" y2="2498.123"/><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="2497.123"/><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="2501.123"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="2521.6582">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="340" y="113.334">Position Event Handler</text><ellipse cx="420" cy="83.7988" fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="416,71.7988,422,66.7988,420,71.7988,422,76.7988,416,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="340" y="2510.6582">Position Event Handler</text><ellipse cx="420" cy="2529.6113" fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="416,2517.6113,422,2512.6113,420,2517.6113,422,2522.6113,416,2517.6113" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="978" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="974" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="981" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="978" y="2497.123"/><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="974" y="2501.123"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="981" y="2521.6582">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1110" y="113.334">Event-Topic</text><ellipse cx="1154.5" cy="83.7988" fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1142.5" x2="1166.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1110" y="2510.6582">Event-Topic</text><ellipse cx="1154.5" cy="2529.6113" fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1142.5" x2="1166.5" y1="2543.6113" y2="2543.6113"/><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1213" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1209" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1216" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1213" y="2497.123"/><rect fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1209" y="2501.123"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1216" y="2521.6582">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1366" y="113.334">Position DAO</text><ellipse cx="1414" cy="83.7988" fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1402" x2="1426" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1366" y="2510.6582">Position DAO</text><ellipse cx="1414" cy="2529.6113" fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1402" x2="1426" y1="2543.6113" y2="2543.6113"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1472" y="113.334">Transfer DAO</text><ellipse cx="1521.5" cy="83.7988" fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1509.5" x2="1533.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1472" y="2510.6582">Transfer DAO</text><ellipse cx="1521.5" cy="2529.6113" fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1509.5" x2="1533.5" y1="2543.6113" y2="2543.6113"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1676" y="113.334">Central Store</text><path d="M1706,63.7988 C1706,53.7988 1724,53.7988 1724,53.7988 C1724,53.7988 1742,53.7988 1742,63.7988 L1742,89.7988 C1742,99.7988 1724,99.7988 1724,99.7988 C1724,99.7988 1706,99.7988 1706,89.7988 L1706,63.7988 " fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1706,63.7988 C1706,73.7988 1724,73.7988 1724,73.7988 C1724,73.7988 1742,73.7988 1742,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1676" y="2510.6582">Central Store</text><path d="M1706,2523.6113 C1706,2513.6113 1724,2513.6113 1724,2513.6113 C1724,2513.6113 1742,2513.6113 1742,2523.6113 L1742,2549.6113 C1742,2559.6113 1724,2559.6113 1724,2559.6113 C1724,2559.6113 1706,2559.6113 1706,2549.6113 L1706,2523.6113 " fill="#FEFECE" filter="url(#f1jsveuzrtbp1m)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1706,2523.6113 C1706,2533.6113 1724,2533.6113 1724,2533.6113 C1724,2533.6113 1742,2533.6113 1742,2523.6113 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.5977"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="2339.5254" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="1419.1934"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="451.082"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="686.9453"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="1517.7695"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1516.5" y="869.498"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1516.5" y="1824.2539"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="480.3926"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="716.2559"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="898.8086"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="1547.0801"/><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="1853.5645"/><rect fill="none" height="2347.8359" style="stroke: #000000; stroke-width: 2.0;" width="1816" x="13" y="133.2871"/><polygon fill="#EEEEEE" points="13,133.2871,236,133.2871,236,140.2871,226,150.2871,13,150.2871,13,133.2871" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Position Handler Consume</text><polygon fill="#A80036" points="124,167.5977,114,171.5977,124,175.5977,120,171.5977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="118" x2="414" y1="171.5977" y2="171.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="130" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="143" y="167.166">Consume Position event message for Payer</text><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="879" x="330" y="216.9082"/><polygon fill="#EEEEEE" points="330,216.9082,545,216.9082,545,223.9082,535,233.9082,330,233.9082,330,216.9082" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="345" y="230.4766">Persist Event Information</text><polygon fill="#A80036" points="1142.5,276.2188,1152.5,280.2188,1142.5,284.2188,1146.5,280.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1148.5" y1="280.2188" y2="280.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="275.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="445" y="275.7871">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1jsveuzrtbp1m)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="861" x="337" y="288.5293"/><polygon fill="#EEEEEE" points="337,288.5293,401,288.5293,401,295.5293,391,305.5293,337,305.5293,337,288.5293" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="350" y="303.0977">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="668.5" y="322.0977">Event Handler Consume {9.1.0.}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="672.5" y="337.4082"/><rect fill="none" height="2085.6621" style="stroke: #000000; stroke-width: 2.0;" width="1499" x="320" y="388.4609"/><polygon fill="#EEEEEE" points="320,388.4609,382,388.4609,382,395.4609,372,405.4609,320,405.4609,320,388.4609" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="335" y="402.0293">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="397" y="401.0957">[Calulate &amp; Validate Latest Position (success)]</text><rect fill="none" height="404.416" style="stroke: #000000; stroke-width: 2.0;" width="1466" x="330" y="412.7715"/><polygon fill="#EEEEEE" points="330,412.7715,629,412.7715,629,419.7715,619,429.7715,330,429.7715,330,412.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="345" y="426.3398">Calculate position and persist change</text><polygon fill="#A80036" points="1397,447.082,1407,451.082,1397,455.082,1401,451.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1403" y1="451.082" y2="451.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="446.6504">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="445" y="446.6504">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1707,476.3926,1717,480.3926,1707,484.3926,1711,480.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1419" x2="1713" y1="480.3926" y2="480.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1426" y="475.9609">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1439" y="475.9609">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1jsveuzrtbp1m)" points="1672,523.7031,1776,523.7031,1786,534.7031,1776,546.7031,1672,546.7031,1662,534.7031,1672,523.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1674" y="540.2715">transferPosition</text><polygon fill="#A80036" points="436,569.0137,426,573.0137,436,577.0137,432,573.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1413" y1="573.0137" y2="573.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="442" y="568.582">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="455" y="568.582">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="602.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="602.6348" y2="615.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="615.6348" y2="615.6348"/><polygon fill="#A80036" points="436,611.6348,426,615.6348,436,619.6348,432,615.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="597.8926">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="445" y="597.8926">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="644.9453" y2="644.9453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="644.9453" y2="657.9453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="657.9453" y2="657.9453"/><polygon fill="#A80036" points="436,653.9453,426,657.9453,436,661.9453,432,657.9453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="640.2031">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="445" y="640.2031">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1397,682.9453,1407,686.9453,1397,690.9453,1401,686.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1403" y1="686.9453" y2="686.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="682.5137">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="445" y="682.5137">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1707,712.2559,1717,716.2559,1707,720.2559,1711,716.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1419" x2="1713" y1="716.2559" y2="716.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1426" y="711.8242">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1439" y="711.8242">Persist latest position to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1jsveuzrtbp1m)" points="1672,759.5664,1776,759.5664,1786,770.5664,1776,782.5664,1672,782.5664,1662,770.5664,1672,759.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1674" y="776.1348">transferPosition</text><polygon fill="#A80036" points="436,804.877,426,808.877,436,812.877,432,808.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1413" y1="808.877" y2="808.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="804.4453">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="804.4453">Return success</text><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1479" x="330" y="831.1875"/><polygon fill="#EEEEEE" points="330,831.1875,894,831.1875,894,838.1875,884,848.1875,330,848.1875,330,831.1875" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="345" y="844.7559">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1504.5,865.498,1514.5,869.498,1504.5,873.498,1508.5,869.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1510.5" y1="869.498" y2="869.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="865.0664">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="454" y="865.0664">Request to persist transfer</text><polygon fill="#A80036" points="1707,894.8086,1717,898.8086,1707,902.8086,1711,898.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1526.5" x2="1713" y1="898.8086" y2="898.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1533.5" y="894.377">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1555.5" y="894.377">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1jsveuzrtbp1m)" points="1658,942.1191,1789,942.1191,1799,953.1191,1789,965.1191,1658,965.1191,1648,953.1191,1658,942.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1660" y="958.6875">transferStateChange</text><polygon fill="#A80036" points="436,987.4297,426,991.4297,436,995.4297,432,991.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1520.5" y1="991.4297" y2="991.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="986.998">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="986.998">Return success</text><polygon fill="#FFFF00" filter="url(#f1jsveuzrtbp1m)" points="430,1011.7402,430,1388.7402,692,1388.7402,692,1021.7402,682,1011.7402,430,1011.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="682" x2="682" y1="1011.7402" y2="1021.7402"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="692" x2="682" y1="1021.7402" y2="1021.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="436" y="1029.3086">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1044.6191">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="1059.9297">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="452" y="1075.2402">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="452" y="1090.5508">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="452" y="1105.8613">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="452" y="1121.1719">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="468" y="1136.4824">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="468" y="1151.793">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="452" y="1167.1035">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="452" y="1182.4141">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="468" y="1197.7246">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="1213.0352">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="484" y="1228.3457">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="484" y="1243.6563">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="484" y="1258.9668">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="484" y="1274.2773">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="484" y="1289.5879">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="500" y="1304.8984">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="500" y="1320.209">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="1335.5195">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="1350.8301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="452" y="1366.1406">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1381.4512">}</text><polygon fill="#A80036" points="1020,1415.1934,1030,1419.1934,1020,1423.1934,1024,1419.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1026" y1="1419.1934" y2="1419.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1414.7617">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="454" y="1414.7617">Publish Transfer event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="320" x2="1819" y1="1458.5039" y2="1458.5039"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="267" x="325" y="1469.1387">[alt Calulate &amp; Validate Latest Position (failure)]</text><rect fill="none" height="292.4844" style="stroke: #000000; stroke-width: 2.0;" width="1466" x="330" y="1479.459"/><polygon fill="#EEEEEE" points="330,1479.459,629,1479.459,629,1486.459,619,1496.459,330,1496.459,330,1479.459" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="345" y="1493.0273">Calculate position and persist change</text><polygon fill="#A80036" points="1397,1513.7695,1407,1517.7695,1397,1521.7695,1401,1517.7695" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1403" y1="1517.7695" y2="1517.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1513.3379">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="454" y="1513.3379">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1707,1543.0801,1717,1547.0801,1707,1551.0801,1711,1547.0801" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1419" x2="1713" y1="1547.0801" y2="1547.0801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1426" y="1542.6484">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1448" y="1542.6484">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1jsveuzrtbp1m)" points="1672,1590.3906,1776,1590.3906,1786,1601.3906,1776,1613.3906,1672,1613.3906,1662,1601.3906,1672,1590.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1674" y="1606.959">transferPosition</text><polygon fill="#A80036" points="436,1635.7012,426,1639.7012,436,1643.7012,432,1639.7012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1413" y1="1639.7012" y2="1639.7012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1635.2695">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="464" y="1635.2695">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="1669.3223" y2="1669.3223"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="1669.3223" y2="1682.3223"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="1682.3223" y2="1682.3223"/><polygon fill="#A80036" points="436,1678.3223,426,1682.3223,436,1686.3223,432,1682.3223" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1664.5801">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="454" y="1664.5801">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="1711.6328" y2="1711.6328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="1711.6328" y2="1724.6328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="1724.6328" y2="1724.6328"/><polygon fill="#A80036" points="436,1720.6328,426,1724.6328,436,1728.6328,432,1724.6328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1706.8906">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="454" y="1706.8906">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#FF0000" filter="url(#f1jsveuzrtbp1m)" points="430,1737.6328,430,1762.6328,562,1762.6328,562,1747.6328,552,1737.6328,430,1737.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="552" x2="552" y1="1737.6328" y2="1747.6328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="562" x2="552" y1="1747.6328" y2="1747.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="436" y="1755.2012">Validation failure!</text><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1479" x="330" y="1785.9434"/><polygon fill="#EEEEEE" points="330,1785.9434,891,1785.9434,891,1792.9434,881,1802.9434,330,1802.9434,330,1785.9434" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="516" x="345" y="1799.5117">Persist Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="1504.5,1820.2539,1514.5,1824.2539,1504.5,1828.2539,1508.5,1824.2539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1510.5" y1="1824.2539" y2="1824.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1819.8223">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="454" y="1819.8223">Request to persist transfer</text><polygon fill="#A80036" points="1707,1849.5645,1717,1853.5645,1707,1857.5645,1711,1853.5645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1526.5" x2="1713" y1="1853.5645" y2="1853.5645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1533.5" y="1849.1328">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1555.5" y="1849.1328">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1jsveuzrtbp1m)" points="1658,1896.875,1789,1896.875,1799,1907.875,1789,1919.875,1658,1919.875,1648,1907.875,1658,1896.875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1660" y="1913.4434">transferStateChange</text><polygon fill="#A80036" points="436,1942.1855,426,1946.1855,436,1950.1855,432,1946.1855" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1520.5" y1="1946.1855" y2="1946.1855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1941.7539">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="1941.7539">Return success</text><polygon fill="#FFFF00" filter="url(#f1jsveuzrtbp1m)" points="430,1966.4961,430,2435.4961,840,2435.4961,840,1976.4961,830,1966.4961,430,1966.4961" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="830" x2="830" y1="1966.4961" y2="1976.4961"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="840" x2="830" y1="1976.4961" y2="1976.4961"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="436" y="1984.0645">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1999.375">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="2014.6855">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="452" y="2029.9961">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="2045.3066">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="452" y="2060.6172">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="452" y="2075.9277">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="468" y="2091.2383">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="468" y="2106.5488">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="484" y="2121.8594">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="500" y="2137.1699">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="500" y="2152.4805">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="500" y="2167.791">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="2183.1016">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="452" y="2198.4121">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="452" y="2213.7227">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="468" y="2229.0332">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="2244.3438">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="484" y="2259.6543">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="484" y="2274.9648">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="484" y="2290.2754">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="484" y="2305.5859">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="484" y="2320.8965">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="500" y="2336.207">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="500" y="2351.5176">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="500" y="2366.8281">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="2382.1387">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="2397.4492">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="452" y="2412.7598">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="2428.0703">}</text><polygon fill="#A80036" points="1270.5,2461.8125,1280.5,2465.8125,1270.5,2469.8125,1274.5,2465.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="1276.5" y1="2465.8125" y2="2465.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="427" y="2461.3809">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="449" y="2461.3809">Publishes Notifications (failure) event for Payer</text><!--
@startuml
' declate title
title 1.1.2. Position Handler Consume (single message)

autonumber

' Actor Keys:
'   boundary - APIs/Interfaces, etc
'   collections - Kafka Topics
'   control - Kafka Consumers
'   entity - Database Access Objects
'   database - Database Persistance Store

' declare actors
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
entity "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant TRANS_DAO
    participant DB
end box

' start flow
activate POS_HANDLER
group Position Handler Consume
    TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event message for Payer
    activate TOPIC_POSITION_DFSP1
    deactivate TOPIC_POSITION_DFSP1
    group Persist Event Information
        |||
        POS_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over POS_HANDLER, TOPIC_EVENTS :  Event Handler Consume {9.1.0.} \n
        |||
    end

    alt Calulate & Validate Latest Position (success)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    else alt Calulate & Validate Latest Position (failure)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            note right of POS_HANDLER #red: Validation failure!
        end
        
        group Persist Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publishes Notifications (failure) event for Payer
        deactivate POS_HANDLER
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2017.18(Fri Oct 06 17:56:32 BST 2017)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_152-b16
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>