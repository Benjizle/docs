<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2603px" preserveAspectRatio="none" style="width:1861px;height:2603px;" version="1.1" viewBox="0 0 1861 2603" width="1861px" zoomAndPan="magnify"><defs><filter height="300%" id="fjjh0wehsg1x6" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="372" x="745.5" y="23.5352">1.1.2.a. Position Handler Consume (single message)</text><rect fill="#FFFFE0" height="2557.7441" style="stroke: #A80036; stroke-width: 1.0;" width="1778" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="857.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.5977"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="2368.1465" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="1418.5039"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293.5" y="2464.4336"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="451.082"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="686.2559"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="1517.0801"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1532.5" y="868.8086"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1532.5" y="1822.875"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1740" y="480.3926"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1740" y="715.5664"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1740" y="898.1191"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1740" y="1546.3906"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1740" y="1852.1855"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="2376.457" style="stroke: #000000; stroke-width: 2.0;" width="1837" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="895" x="330" y="216.9082"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="2114.2832" style="stroke: #000000; stroke-width: 2.0;" width="1520" x="320" y="388.4609"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="403.7266" style="stroke: #000000; stroke-width: 2.0;" width="1487" x="330" y="412.7715"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1500" x="330" y="830.498"/><rect fill="#FFFFFF" height="1045.9297" style="stroke: none; stroke-width: 1.0;" width="1520" x="320" y="1456.8145"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="291.7949" style="stroke: #000000; stroke-width: 2.0;" width="1487" x="330" y="1478.7695"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1500" x="330" y="1784.5645"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="108" x2="108" y1="116.2871" y2="2526.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="420" x2="420" y1="116.2871" y2="2526.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1037" x2="1037" y1="116.2871" y2="2526.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1162" x2="1162" y1="116.2871" y2="2526.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1298" x2="1298" y1="116.2871" y2="2526.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1430" x2="1430" y1="116.2871" y2="2526.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1537" x2="1537" y1="116.2871" y2="2526.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1745" x2="1745" y1="116.2871" y2="2526.7441"/><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="2525.7441"/><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="2529.7441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="2550.2793">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="340" y="113.334">Position Event Handler</text><ellipse cx="420" cy="83.7988" fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="416,71.7988,422,66.7988,420,71.7988,422,76.7988,416,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="340" y="2539.2793">Position Event Handler</text><ellipse cx="420" cy="2558.2324" fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="416,2546.2324,422,2541.2324,420,2546.2324,422,2551.2324,416,2546.2324" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="978" y="76.7988"/><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="974" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="981" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="978" y="2525.7441"/><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="974" y="2529.7441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="981" y="2550.2793">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1114" y="76.7988"/><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1110" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1117" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1114" y="2525.7441"/><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1110" y="2529.7441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1117" y="2550.2793">Event-Topic</text><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1229" y="76.7988"/><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1225" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1232" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1229" y="2525.7441"/><rect fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1225" y="2529.7441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1232" y="2550.2793">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1382" y="113.334">Position DAO</text><ellipse cx="1430" cy="83.7988" fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1418" x2="1442" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1382" y="2539.2793">Position DAO</text><ellipse cx="1430" cy="2558.2324" fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1418" x2="1442" y1="2572.2324" y2="2572.2324"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1488" y="113.334">Transfer DAO</text><ellipse cx="1537.5" cy="83.7988" fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1525.5" x2="1549.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1488" y="2539.2793">Transfer DAO</text><ellipse cx="1537.5" cy="2558.2324" fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1525.5" x2="1549.5" y1="2572.2324" y2="2572.2324"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1697" y="113.334">Central Store</text><path d="M1727,63.7988 C1727,53.7988 1745,53.7988 1745,53.7988 C1745,53.7988 1763,53.7988 1763,63.7988 L1763,89.7988 C1763,99.7988 1745,99.7988 1745,99.7988 C1745,99.7988 1727,99.7988 1727,89.7988 L1727,63.7988 " fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1727,63.7988 C1727,73.7988 1745,73.7988 1745,73.7988 C1745,73.7988 1763,73.7988 1763,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1697" y="2539.2793">Central Store</text><path d="M1727,2552.2324 C1727,2542.2324 1745,2542.2324 1745,2542.2324 C1745,2542.2324 1763,2542.2324 1763,2552.2324 L1763,2578.2324 C1763,2588.2324 1745,2588.2324 1745,2588.2324 C1745,2588.2324 1727,2588.2324 1727,2578.2324 L1727,2552.2324 " fill="#FEFECE" filter="url(#fjjh0wehsg1x6)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1727,2552.2324 C1727,2562.2324 1745,2562.2324 1745,2562.2324 C1745,2562.2324 1763,2562.2324 1763,2552.2324 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.5977"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="2368.1465" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="1418.5039"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293.5" y="2464.4336"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="451.082"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="686.2559"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="1517.0801"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1532.5" y="868.8086"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1532.5" y="1822.875"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1740" y="480.3926"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1740" y="715.5664"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1740" y="898.1191"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1740" y="1546.3906"/><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1740" y="1852.1855"/><rect fill="none" height="2376.457" style="stroke: #000000; stroke-width: 2.0;" width="1837" x="13" y="133.2871"/><polygon fill="#EEEEEE" points="13,133.2871,236,133.2871,236,140.2871,226,150.2871,13,150.2871,13,133.2871" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Position Handler Consume</text><polygon fill="#A80036" points="124,167.5977,114,171.5977,124,175.5977,120,171.5977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="118" x2="414" y1="171.5977" y2="171.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="130" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="143" y="167.166">Consume Position event message for Payer</text><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="895" x="330" y="216.9082"/><polygon fill="#EEEEEE" points="330,216.9082,545,216.9082,545,223.9082,535,233.9082,330,233.9082,330,216.9082" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="345" y="230.4766">Persist Event Information</text><polygon fill="#A80036" points="1150.5,276.2188,1160.5,280.2188,1150.5,284.2188,1154.5,280.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1156.5" y1="280.2188" y2="280.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="275.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="445" y="275.7871">Publish event information</text><rect fill="#FFFFFF" filter="url(#fjjh0wehsg1x6)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="877" x="337" y="288.5293"/><polygon fill="#EEEEEE" points="337,288.5293,401,288.5293,401,295.5293,391,305.5293,337,305.5293,337,288.5293" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="350" y="303.0977">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="676.5" y="322.0977">Event Handler Consume {9.1.0.}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="680.5" y="337.4082"/><rect fill="none" height="2114.2832" style="stroke: #000000; stroke-width: 2.0;" width="1520" x="320" y="388.4609"/><polygon fill="#EEEEEE" points="320,388.4609,382,388.4609,382,395.4609,372,405.4609,320,405.4609,320,388.4609" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="335" y="402.0293">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="397" y="401.0957">[Calulate &amp; Validate Latest Position (success)]</text><rect fill="none" height="403.7266" style="stroke: #000000; stroke-width: 2.0;" width="1487" x="330" y="412.7715"/><polygon fill="#EEEEEE" points="330,412.7715,629,412.7715,629,419.7715,619,429.7715,330,429.7715,330,412.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="345" y="426.3398">Calculate position and persist change</text><polygon fill="#A80036" points="1413,447.082,1423,451.082,1413,455.082,1417,451.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1419" y1="451.082" y2="451.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="446.6504">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="445" y="446.6504">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1728,476.3926,1738,480.3926,1728,484.3926,1732,480.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435" x2="1734" y1="480.3926" y2="480.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1442" y="475.9609">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1455" y="475.9609">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fjjh0wehsg1x6)" points="1693,493.7031,1797,493.7031,1807,504.7031,1797,516.7031,1693,516.7031,1683,504.7031,1693,493.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1695" y="510.2715">transferPosition</text><polygon fill="#A80036" points="1446,539.0137,1436,543.0137,1446,547.0137,1442,543.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1440" x2="1744" y1="543.0137" y2="543.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1452" y="538.582">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1465" y="538.582">Retrieve latest position from DB for Payer</text><polygon fill="#A80036" points="436,568.3242,426,572.3242,436,576.3242,432,572.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1429" y1="572.3242" y2="572.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="442" y="567.8926">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="455" y="567.8926">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="601.9453" y2="601.9453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="601.9453" y2="614.9453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="614.9453" y2="614.9453"/><polygon fill="#A80036" points="436,610.9453,426,614.9453,436,618.9453,432,614.9453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="597.2031">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="445" y="597.2031">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="644.2559" y2="644.2559"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="644.2559" y2="657.2559"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="657.2559" y2="657.2559"/><polygon fill="#A80036" points="436,653.2559,426,657.2559,436,661.2559,432,657.2559" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="639.5137">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="445" y="639.5137">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1413,682.2559,1423,686.2559,1413,690.2559,1417,686.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1419" y1="686.2559" y2="686.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="681.8242">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="445" y="681.8242">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1728,711.5664,1738,715.5664,1728,719.5664,1732,715.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435" x2="1734" y1="715.5664" y2="715.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442" y="711.1348">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1464" y="711.1348">Persist latest position to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fjjh0wehsg1x6)" points="1693,758.877,1797,758.877,1807,769.877,1797,781.877,1693,781.877,1683,769.877,1693,758.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1695" y="775.4453">transferPosition</text><polygon fill="#A80036" points="436,804.1875,426,808.1875,436,812.1875,432,808.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1429" y1="808.1875" y2="808.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="803.7559">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="803.7559">Return success</text><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1500" x="330" y="830.498"/><polygon fill="#EEEEEE" points="330,830.498,894,830.498,894,837.498,884,847.498,330,847.498,330,830.498" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="345" y="844.0664">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1520.5,864.8086,1530.5,868.8086,1520.5,872.8086,1524.5,868.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1526.5" y1="868.8086" y2="868.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="864.377">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="454" y="864.377">Request to persist transfer</text><polygon fill="#A80036" points="1728,894.1191,1738,898.1191,1728,902.1191,1732,898.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1542.5" x2="1734" y1="898.1191" y2="898.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1549.5" y="893.6875">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1571.5" y="893.6875">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fjjh0wehsg1x6)" points="1679,941.4297,1810,941.4297,1820,952.4297,1810,964.4297,1679,964.4297,1669,952.4297,1679,941.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1681" y="957.998">transferStateChange</text><polygon fill="#A80036" points="436,986.7402,426,990.7402,436,994.7402,432,990.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1536.5" y1="990.7402" y2="990.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="986.3086">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="986.3086">Return success</text><polygon fill="#FFFF00" filter="url(#fjjh0wehsg1x6)" points="430,1011.0508,430,1388.0508,692,1388.0508,692,1021.0508,682,1011.0508,430,1011.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="682" x2="682" y1="1011.0508" y2="1021.0508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="692" x2="682" y1="1021.0508" y2="1021.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="436" y="1028.6191">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1043.9297">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="1059.2402">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="452" y="1074.5508">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="452" y="1089.8613">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="452" y="1105.1719">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="452" y="1120.4824">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="468" y="1135.793">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="468" y="1151.1035">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="452" y="1166.4141">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="452" y="1181.7246">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="468" y="1197.0352">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="1212.3457">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="484" y="1227.6563">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="484" y="1242.9668">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="484" y="1258.2773">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="484" y="1273.5879">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="484" y="1288.8984">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="500" y="1304.209">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="500" y="1319.5195">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="1334.8301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="1350.1406">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="452" y="1365.4512">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1380.7617">}</text><polygon fill="#A80036" points="1020,1414.5039,1030,1418.5039,1020,1422.5039,1024,1418.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1026" y1="1418.5039" y2="1418.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1414.0723">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="454" y="1414.0723">Publish Transfer event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="320" x2="1840" y1="1457.8145" y2="1457.8145"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="325" y="1468.4492">[Calculate &amp; Validate Latest Position (failure)]</text><rect fill="none" height="291.7949" style="stroke: #000000; stroke-width: 2.0;" width="1487" x="330" y="1478.7695"/><polygon fill="#EEEEEE" points="330,1478.7695,629,1478.7695,629,1485.7695,619,1495.7695,330,1495.7695,330,1478.7695" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="345" y="1492.3379">Calculate position and persist change</text><polygon fill="#A80036" points="1413,1513.0801,1423,1517.0801,1413,1521.0801,1417,1517.0801" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1419" y1="1517.0801" y2="1517.0801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1512.6484">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="454" y="1512.6484">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1728,1542.3906,1738,1546.3906,1728,1550.3906,1732,1546.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435" x2="1734" y1="1546.3906" y2="1546.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442" y="1541.959">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1464" y="1541.959">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fjjh0wehsg1x6)" points="1693,1559.7012,1797,1559.7012,1807,1570.7012,1797,1582.7012,1693,1582.7012,1683,1570.7012,1693,1559.7012" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1695" y="1576.2695">transferPosition</text><polygon fill="#A80036" points="1446,1605.0117,1436,1609.0117,1446,1613.0117,1442,1609.0117" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1440" x2="1744" y1="1609.0117" y2="1609.0117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1452" y="1604.5801">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1474" y="1604.5801">Retrieve latest position from DB for Payer</text><polygon fill="#A80036" points="436,1634.3223,426,1638.3223,436,1642.3223,432,1638.3223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1429" y1="1638.3223" y2="1638.3223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1633.8906">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="464" y="1633.8906">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="1667.9434" y2="1667.9434"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="1667.9434" y2="1680.9434"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="1680.9434" y2="1680.9434"/><polygon fill="#A80036" points="436,1676.9434,426,1680.9434,436,1684.9434,432,1680.9434" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1663.2012">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="454" y="1663.2012">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="1710.2539" y2="1710.2539"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="1710.2539" y2="1723.2539"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="1723.2539" y2="1723.2539"/><polygon fill="#A80036" points="436,1719.2539,426,1723.2539,436,1727.2539,432,1723.2539" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1705.5117">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="454" y="1705.5117">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#FF0000" filter="url(#fjjh0wehsg1x6)" points="430,1736.2539,430,1761.2539,562,1761.2539,562,1746.2539,552,1736.2539,430,1736.2539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="552" x2="552" y1="1736.2539" y2="1746.2539"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="562" x2="552" y1="1746.2539" y2="1746.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="436" y="1753.8223">Validation failure!</text><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1500" x="330" y="1784.5645"/><polygon fill="#EEEEEE" points="330,1784.5645,891,1784.5645,891,1791.5645,881,1801.5645,330,1801.5645,330,1784.5645" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="516" x="345" y="1798.1328">Persist Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="1520.5,1818.875,1530.5,1822.875,1520.5,1826.875,1524.5,1822.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1526.5" y1="1822.875" y2="1822.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1818.4434">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="454" y="1818.4434">Request to persist transfer</text><polygon fill="#A80036" points="1728,1848.1855,1738,1852.1855,1728,1856.1855,1732,1852.1855" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1542.5" x2="1734" y1="1852.1855" y2="1852.1855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1549.5" y="1847.7539">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1571.5" y="1847.7539">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fjjh0wehsg1x6)" points="1679,1895.4961,1810,1895.4961,1820,1906.4961,1810,1918.4961,1679,1918.4961,1669,1906.4961,1679,1895.4961" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1681" y="1912.0645">transferStateChange</text><polygon fill="#A80036" points="436,1940.8066,426,1944.8066,436,1948.8066,432,1944.8066" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1536.5" y1="1944.8066" y2="1944.8066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1940.375">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="1940.375">Return success</text><polygon fill="#FFFF00" filter="url(#fjjh0wehsg1x6)" points="430,1965.1172,430,2434.1172,840,2434.1172,840,1975.1172,830,1965.1172,430,1965.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="830" x2="830" y1="1965.1172" y2="1975.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="840" x2="830" y1="1975.1172" y2="1975.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="436" y="1982.6855">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1997.9961">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="2013.3066">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="452" y="2028.6172">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="2043.9277">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="452" y="2059.2383">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="452" y="2074.5488">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="468" y="2089.8594">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="468" y="2105.1699">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="484" y="2120.4805">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="500" y="2135.791">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="500" y="2151.1016">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="500" y="2166.4121">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="2181.7227">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="452" y="2197.0332">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="452" y="2212.3438">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="468" y="2227.6543">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="2242.9648">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="484" y="2258.2754">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="484" y="2273.5859">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="484" y="2288.8965">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="484" y="2304.207">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="484" y="2319.5176">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="500" y="2334.8281">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="500" y="2350.1387">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="500" y="2365.4492">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="2380.7598">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="2396.0703">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="452" y="2411.3809">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="2426.6914">}</text><polygon fill="#A80036" points="1281.5,2460.4336,1291.5,2464.4336,1281.5,2468.4336,1285.5,2464.4336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1287.5" y1="2464.4336" y2="2464.4336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="2460.002">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="454" y="2460.002">Publish Notification (failure) event for Payer</text><!--
@startuml
' declate title
title 1.1.2.a. Position Handler Consume (single message)

autonumber

' Actor Keys:
'   boundary - APIs/Interfaces, etc
'   collections - Kafka Topics
'   control - Kafka Consumers
'   entity - Database Access Objects
'   database - Database Persistance Store

' declare actors
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant TRANS_DAO
    participant DB
end box

' start flow
activate POS_HANDLER
group Position Handler Consume
    TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event message for Payer
    activate TOPIC_POSITION_DFSP1
    deactivate TOPIC_POSITION_DFSP1
    group Persist Event Information
        |||
        POS_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over POS_HANDLER, TOPIC_EVENTS :  Event Handler Consume {9.1.0.} \n
        |||
    end

    alt Calulate & Validate Latest Position (success)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            activate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            DB -> POS_DAO: Retrieve latest position from DB for Payer
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    else Calculate & Validate Latest Position (failure)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            activate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            DB -> POS_DAO: Retrieve latest position from DB for Payer
            deactivate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            note right of POS_HANDLER #red: Validation failure!
        end
        
        group Persist Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
        deactivate POS_HANDLER
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2017.18(Fri Oct 06 17:56:32 BST 2017)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_152-b16
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>