<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2524px" preserveAspectRatio="none" style="width:1840px;height:2524px;" version="1.1" viewBox="0 0 1840 2524" width="1840px" zoomAndPan="magnify"><defs><filter height="300%" id="fb6tho2x5bm1t" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="361" x="740.5" y="23.5352">1.1.2. Position Handler Consume (single message)</text><rect fill="#FFFFE0" height="2479.4336" style="stroke: #A80036; stroke-width: 1.0;" width="1757" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="847" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.5977"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="2289.8359" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="1308.2617"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="340.1504"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="576.0137"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="1406.8379"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1516.5" y="758.5664"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1516.5" y="1713.3223"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="369.4609"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="605.3242"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="787.877"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="1436.1484"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="1742.6328"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="2298.1465" style="stroke: #000000; stroke-width: 2.0;" width="1816" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="46.6211" style="stroke: #000000; stroke-width: 2.0;" width="879" x="330" y="216.9082"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="2146.9043" style="stroke: #000000; stroke-width: 2.0;" width="1499" x="320" y="277.5293"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="404.416" style="stroke: #000000; stroke-width: 2.0;" width="1466" x="330" y="301.8398"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1479" x="330" y="720.2559"/><rect fill="#FFFFFF" height="1077.8613" style="stroke: none; stroke-width: 1.0;" width="1499" x="320" y="1346.5723"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="292.4844" style="stroke: #000000; stroke-width: 2.0;" width="1466" x="330" y="1368.5273"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1479" x="330" y="1675.0117"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="108" x2="108" y1="116.2871" y2="2448.4336"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="420" x2="420" y1="116.2871" y2="2448.4336"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1037" x2="1037" y1="116.2871" y2="2448.4336"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1154" x2="1154" y1="116.2871" y2="2448.4336"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1282" x2="1282" y1="116.2871" y2="2448.4336"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1414" x2="1414" y1="116.2871" y2="2448.4336"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1521" x2="1521" y1="116.2871" y2="2448.4336"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1724" x2="1724" y1="116.2871" y2="2448.4336"/><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="2447.4336"/><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="2451.4336"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="2471.9688">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="340" y="113.334">Position Event Handler</text><ellipse cx="420" cy="83.7988" fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="416,71.7988,422,66.7988,420,71.7988,422,76.7988,416,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="340" y="2460.9688">Position Event Handler</text><ellipse cx="420" cy="2479.9219" fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="416,2467.9219,422,2462.9219,420,2467.9219,422,2472.9219,416,2467.9219" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="978" y="76.7988"/><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="974" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="981" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="978" y="2447.4336"/><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="974" y="2451.4336"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="981" y="2471.9688">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1110" y="113.334">Event-Topic</text><ellipse cx="1154.5" cy="83.7988" fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1142.5" x2="1166.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1110" y="2460.9688">Event-Topic</text><ellipse cx="1154.5" cy="2479.9219" fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1142.5" x2="1166.5" y1="2493.9219" y2="2493.9219"/><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1213" y="76.7988"/><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1209" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1216" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1213" y="2447.4336"/><rect fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1209" y="2451.4336"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1216" y="2471.9688">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1366" y="113.334">Position DAO</text><ellipse cx="1414" cy="83.7988" fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1402" x2="1426" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1366" y="2460.9688">Position DAO</text><ellipse cx="1414" cy="2479.9219" fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1402" x2="1426" y1="2493.9219" y2="2493.9219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1472" y="113.334">Transfer DAO</text><ellipse cx="1521.5" cy="83.7988" fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1509.5" x2="1533.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1472" y="2460.9688">Transfer DAO</text><ellipse cx="1521.5" cy="2479.9219" fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1509.5" x2="1533.5" y1="2493.9219" y2="2493.9219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1676" y="113.334">Central Store</text><path d="M1706,63.7988 C1706,53.7988 1724,53.7988 1724,53.7988 C1724,53.7988 1742,53.7988 1742,63.7988 L1742,89.7988 C1742,99.7988 1724,99.7988 1724,99.7988 C1724,99.7988 1706,99.7988 1706,89.7988 L1706,63.7988 " fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1706,63.7988 C1706,73.7988 1724,73.7988 1724,73.7988 C1724,73.7988 1742,73.7988 1742,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1676" y="2460.9688">Central Store</text><path d="M1706,2473.9219 C1706,2463.9219 1724,2463.9219 1724,2463.9219 C1724,2463.9219 1742,2463.9219 1742,2473.9219 L1742,2499.9219 C1742,2509.9219 1724,2509.9219 1724,2509.9219 C1724,2509.9219 1706,2509.9219 1706,2499.9219 L1706,2473.9219 " fill="#FEFECE" filter="url(#fb6tho2x5bm1t)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1706,2473.9219 C1706,2483.9219 1724,2483.9219 1724,2483.9219 C1724,2483.9219 1742,2483.9219 1742,2473.9219 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.5977"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="2289.8359" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="1308.2617"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="340.1504"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="576.0137"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1409" y="1406.8379"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1516.5" y="758.5664"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1516.5" y="1713.3223"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="369.4609"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="605.3242"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="787.877"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="1436.1484"/><rect fill="#FFFFFF" filter="url(#fb6tho2x5bm1t)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1719" y="1742.6328"/><rect fill="none" height="2298.1465" style="stroke: #000000; stroke-width: 2.0;" width="1816" x="13" y="133.2871"/><polygon fill="#EEEEEE" points="13,133.2871,236,133.2871,236,140.2871,226,150.2871,13,150.2871,13,133.2871" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Position Handler Consume</text><polygon fill="#A80036" points="124,167.5977,114,171.5977,124,175.5977,120,171.5977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="118" x2="414" y1="171.5977" y2="171.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="130" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="143" y="167.166">Consume Position event message for Payer</text><rect fill="none" height="46.6211" style="stroke: #000000; stroke-width: 2.0;" width="879" x="330" y="216.9082"/><polygon fill="#EEEEEE" points="330,216.9082,545,216.9082,545,223.9082,535,233.9082,330,233.9082,330,216.9082" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="345" y="230.4766">Persist Event Information</text><polygon fill="#A80036" points="1142.5,251.2188,1152.5,255.2188,1142.5,259.2188,1146.5,255.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1148.5" y1="255.2188" y2="255.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="250.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="445" y="250.7871">Request to persist event information</text><rect fill="none" height="2146.9043" style="stroke: #000000; stroke-width: 2.0;" width="1499" x="320" y="277.5293"/><polygon fill="#EEEEEE" points="320,277.5293,382,277.5293,382,284.5293,372,294.5293,320,294.5293,320,277.5293" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="335" y="291.0977">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="397" y="290.1641">[Calulate &amp; Validate Latest Position (success)]</text><rect fill="none" height="404.416" style="stroke: #000000; stroke-width: 2.0;" width="1466" x="330" y="301.8398"/><polygon fill="#EEEEEE" points="330,301.8398,629,301.8398,629,308.8398,619,318.8398,330,318.8398,330,301.8398" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="345" y="315.4082">Calculate position and persist change</text><polygon fill="#A80036" points="1397,336.1504,1407,340.1504,1397,344.1504,1401,340.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1403" y1="340.1504" y2="340.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="335.7188">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="445" y="335.7188">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1707,365.4609,1717,369.4609,1707,373.4609,1711,369.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1419" x2="1713" y1="369.4609" y2="369.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1426" y="365.0293">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1439" y="365.0293">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fb6tho2x5bm1t)" points="1672,412.7715,1776,412.7715,1786,423.7715,1776,435.7715,1672,435.7715,1662,423.7715,1672,412.7715" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1674" y="429.3398">transferPosition</text><polygon fill="#A80036" points="436,458.082,426,462.082,436,466.082,432,462.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1413" y1="462.082" y2="462.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="442" y="457.6504">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="455" y="457.6504">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="491.7031" y2="491.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="491.7031" y2="504.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="504.7031" y2="504.7031"/><polygon fill="#A80036" points="436,500.7031,426,504.7031,436,508.7031,432,504.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="486.9609">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="445" y="486.9609">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="534.0137" y2="534.0137"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="534.0137" y2="547.0137"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="547.0137" y2="547.0137"/><polygon fill="#A80036" points="436,543.0137,426,547.0137,436,551.0137,432,547.0137" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="529.2715">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="445" y="529.2715">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1397,572.0137,1407,576.0137,1397,580.0137,1401,576.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1403" y1="576.0137" y2="576.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="571.582">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="445" y="571.582">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1707,601.3242,1717,605.3242,1707,609.3242,1711,605.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1419" x2="1713" y1="605.3242" y2="605.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1426" y="600.8926">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1439" y="600.8926">Persist latest position to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fb6tho2x5bm1t)" points="1672,648.6348,1776,648.6348,1786,659.6348,1776,671.6348,1672,671.6348,1662,659.6348,1672,648.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1674" y="665.2031">transferPosition</text><polygon fill="#A80036" points="436,693.9453,426,697.9453,436,701.9453,432,697.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1413" y1="697.9453" y2="697.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="693.5137">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="693.5137">Return success</text><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1479" x="330" y="720.2559"/><polygon fill="#EEEEEE" points="330,720.2559,894,720.2559,894,727.2559,884,737.2559,330,737.2559,330,720.2559" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="345" y="733.8242">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1504.5,754.5664,1514.5,758.5664,1504.5,762.5664,1508.5,758.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1510.5" y1="758.5664" y2="758.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="754.1348">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="454" y="754.1348">Request to persist transfer</text><polygon fill="#A80036" points="1707,783.877,1717,787.877,1707,791.877,1711,787.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1526.5" x2="1713" y1="787.877" y2="787.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1533.5" y="783.4453">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1555.5" y="783.4453">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fb6tho2x5bm1t)" points="1658,831.1875,1789,831.1875,1799,842.1875,1789,854.1875,1658,854.1875,1648,842.1875,1658,831.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1660" y="847.7559">transferStateChange</text><polygon fill="#A80036" points="436,876.498,426,880.498,436,884.498,432,880.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1520.5" y1="880.498" y2="880.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="876.0664">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="876.0664">Return success</text><polygon fill="#FFFF00" filter="url(#fb6tho2x5bm1t)" points="430,900.8086,430,1277.8086,692,1277.8086,692,910.8086,682,900.8086,430,900.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="682" x2="682" y1="900.8086" y2="910.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="692" x2="682" y1="910.8086" y2="910.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="436" y="918.377">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="933.6875">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="948.998">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="452" y="964.3086">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="452" y="979.6191">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="452" y="994.9297">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="452" y="1010.2402">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="468" y="1025.5508">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="468" y="1040.8613">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="452" y="1056.1719">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="452" y="1071.4824">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="468" y="1086.793">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="1102.1035">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="484" y="1117.4141">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="484" y="1132.7246">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="484" y="1148.0352">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="484" y="1163.3457">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="484" y="1178.6563">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="500" y="1193.9668">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="500" y="1209.2773">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="1224.5879">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="1239.8984">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="452" y="1255.209">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1270.5195">}</text><polygon fill="#A80036" points="1020,1304.2617,1030,1308.2617,1020,1312.2617,1024,1308.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1026" y1="1308.2617" y2="1308.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1303.8301">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="454" y="1303.8301">Publish Transfer event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="320" x2="1819" y1="1347.5723" y2="1347.5723"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="267" x="325" y="1358.207">[alt Calulate &amp; Validate Latest Position (failure)]</text><rect fill="none" height="292.4844" style="stroke: #000000; stroke-width: 2.0;" width="1466" x="330" y="1368.5273"/><polygon fill="#EEEEEE" points="330,1368.5273,629,1368.5273,629,1375.5273,619,1385.5273,330,1385.5273,330,1368.5273" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="345" y="1382.0957">Calculate position and persist change</text><polygon fill="#A80036" points="1397,1402.8379,1407,1406.8379,1397,1410.8379,1401,1406.8379" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1403" y1="1406.8379" y2="1406.8379"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1402.4063">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="454" y="1402.4063">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1707,1432.1484,1717,1436.1484,1707,1440.1484,1711,1436.1484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1419" x2="1713" y1="1436.1484" y2="1436.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1426" y="1431.7168">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1448" y="1431.7168">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fb6tho2x5bm1t)" points="1672,1479.459,1776,1479.459,1786,1490.459,1776,1502.459,1672,1502.459,1662,1490.459,1672,1479.459" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1674" y="1496.0273">transferPosition</text><polygon fill="#A80036" points="436,1524.7695,426,1528.7695,436,1532.7695,432,1528.7695" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1413" y1="1528.7695" y2="1528.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1524.3379">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="464" y="1524.3379">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="1558.3906" y2="1558.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="1558.3906" y2="1571.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="1571.3906" y2="1571.3906"/><polygon fill="#A80036" points="436,1567.3906,426,1571.3906,436,1575.3906,432,1571.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1553.6484">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="454" y="1553.6484">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="1600.7012" y2="1600.7012"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="1600.7012" y2="1613.7012"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="1613.7012" y2="1613.7012"/><polygon fill="#A80036" points="436,1609.7012,426,1613.7012,436,1617.7012,432,1613.7012" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1595.959">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="454" y="1595.959">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#FF0000" filter="url(#fb6tho2x5bm1t)" points="430,1626.7012,430,1651.7012,562,1651.7012,562,1636.7012,552,1626.7012,430,1626.7012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="552" x2="552" y1="1626.7012" y2="1636.7012"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="562" x2="552" y1="1636.7012" y2="1636.7012"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="436" y="1644.2695">Validation failure!</text><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1479" x="330" y="1675.0117"/><polygon fill="#EEEEEE" points="330,1675.0117,891,1675.0117,891,1682.0117,881,1692.0117,330,1692.0117,330,1675.0117" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="516" x="345" y="1688.5801">Persist Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="1504.5,1709.3223,1514.5,1713.3223,1504.5,1717.3223,1508.5,1713.3223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1510.5" y1="1713.3223" y2="1713.3223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1708.8906">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="454" y="1708.8906">Request to persist transfer</text><polygon fill="#A80036" points="1707,1738.6328,1717,1742.6328,1707,1746.6328,1711,1742.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1526.5" x2="1713" y1="1742.6328" y2="1742.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1533.5" y="1738.2012">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1555.5" y="1738.2012">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fb6tho2x5bm1t)" points="1658,1785.9434,1789,1785.9434,1799,1796.9434,1789,1808.9434,1658,1808.9434,1648,1796.9434,1658,1785.9434" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1660" y="1802.5117">transferStateChange</text><polygon fill="#A80036" points="436,1831.2539,426,1835.2539,436,1839.2539,432,1835.2539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1520.5" y1="1835.2539" y2="1835.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1830.8223">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="1830.8223">Return success</text><polygon fill="#FFFF00" filter="url(#fb6tho2x5bm1t)" points="430,1855.5645,430,2385.5645,840,2385.5645,840,1865.5645,830,1855.5645,430,1855.5645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="830" x2="830" y1="1855.5645" y2="1865.5645"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="840" x2="830" y1="1865.5645" y2="1865.5645"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="436" y="1873.1328">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1888.4434">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="1903.7539">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="452" y="1919.0645">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="1934.375">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="452" y="1949.6855">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="452" y="1964.9961">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="468" y="1980.3066">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="468" y="1995.6172">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="484" y="2010.9277">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="500" y="2026.2383">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="500" y="2041.5488">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="500" y="2056.8594">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="2072.1699">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="452" y="2087.4805">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="452" y="2102.791">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="468" y="2118.1016">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="2133.4121">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="484" y="2148.7227">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="484" y="2164.0332">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="484" y="2179.3438">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="484" y="2194.6543">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="484" y="2209.9648">status: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="500" y="2225.2754">type: functional</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="500" y="2240.5859">code: failure</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="2255.8965">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="484" y="2271.207">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="500" y="2286.5176">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="500" y="2301.8281">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="500" y="2317.1387">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="2332.4492">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="2347.7598">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="452" y="2363.0703">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="2378.3809">}</text><polygon fill="#A80036" points="1270.5,2412.123,1280.5,2416.123,1270.5,2420.123,1274.5,2416.123" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="1276.5" y1="2416.123" y2="2416.123"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="427" y="2411.6914">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="449" y="2411.6914">Publishes Notifications (failure) event for Payer</text><!--
@startuml
' declate title
title 1.1.2. Position Handler Consume (single message)

autonumber

' Actor Keys:
'   boundary - APIs/Interfaces, etc
'   collections - Kafka Topics
'   control - Kafka Consumers
'   entity - Database Access Objects
'   database - Database Persistance Store

' declare actors
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
entity "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant TRANS_DAO
    participant DB
end box

' start flow
activate POS_HANDLER
group Position Handler Consume
    TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event message for Payer
    activate TOPIC_POSITION_DFSP1
    deactivate TOPIC_POSITION_DFSP1
    group Persist Event Information
        POS_HANDLER -> TOPIC_EVENTS: Request to persist event information
    end

    alt Calulate & Validate Latest Position (success)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    else alt Calulate & Validate Latest Position (failure)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            note right of POS_HANDLER #red: Validation failure!
        end
        
        group Persist Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        status: {
                            type: functional
                            code: failure
                        }
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publishes Notifications (failure) event for Payer
        deactivate POS_HANDLER
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2017.18(Fri Oct 06 17:56:32 BST 2017)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_152-b16
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>